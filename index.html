<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artemisia Story ¬∑ Generatore & Trasformatore di immagini AI</title>
  <link rel="icon" href="logo-artemisia.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-start:#0f172a; --bg-end:#1e1b4b; --card:#0b1020cc; --text:#e2e8f0; --muted:#94a3b8;
      --brand:#6366f1; --brand-2:#8b5cf6; --accent:#f8c045; --ring:rgba(99,102,241,.35);
      --ok:#34d399; --warn:#f59e0b; --err:#f87171; --surface:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.14); --chip:rgba(148,163,184,.12); --shadow:0 18px 60px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg-start:#e8eef8; --bg-end:#dfe4ff; --card:#ffffffee; --text:#0f172a; --muted:#475569;
      --surface:#f8fafc; --border:rgba(2,6,23,.12); --chip:rgba(2,6,23,.06); --shadow:0 18px 50px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background:
        radial-gradient(1000px 600px at -10% -10%, #0ea5e980, transparent 60%),
        radial-gradient(800px 500px at 110% 10%, #a78bfa66, transparent 60%),
        linear-gradient(135deg,var(--bg-start),var(--bg-end));
    }
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:12px;overflow:hidden;background:var(--surface);display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo img{width:100%;height:100%;object-fit:contain}
    .title{font-size:24px;font-weight:800}
    .subtitle{font-size:13px;color:var(--muted)}
    .icon-btn{border:1px solid var(--border);background:var(--surface);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .card{background:var(--card);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:18px}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:20px}
    @media(max-width:1024px){.grid{grid-template-columns:1fr}}
    .section-title{display:flex;align-items:center;gap:8px;font-weight:800;margin-bottom:10px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
    .chip{padding:8px 12px;border:1px solid var(--border);background:var(--chip);border-radius:999px;font-size:12px;cursor:pointer}
    .chip.active{outline:2px solid var(--ring);background:rgba(99,102,241,.18)}
    .tooltip{position:fixed;z-index:50;display:none;pointer-events:none;border:1px solid var(--border);background:var(--card);border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
    .tooltip img{display:block;width:180px;height:120px;object-fit:cover}
    .tooltip .hint{padding:8px 10px;font-size:12px;color:var(--muted);max-width:220px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0;color:var(--muted)}
    .select,.slider{display:flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--surface);padding:10px 12px;border-radius:12px}
    .slider input{accent-color:var(--brand)}
    .textarea{position:relative}
    textarea{width:100%;min-height:140px;resize:vertical;border:2px solid transparent;border-radius:14px;padding:14px 16px;background:var(--surface);color:var(--text);line-height:1.6}
    textarea:focus{outline:none;box-shadow:0 0 0 4px var(--ring)}
    textarea::placeholder{color:var(--muted)}
    .counter{position:absolute;right:12px;bottom:8px;font-size:12px;color:var(--muted)}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);cursor:pointer;background:var(--surface);color:var(--text);font-weight:700}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border:none;color:#fff}
    .status{margin-top:12px;padding:12px 16px;border-radius:12px;font-weight:600;display:none}
    .status.ok{background:rgba(52,211,153,.1);color:var(--ok);border:1px solid rgba(52,211,153,.3)}
    .status.err{background:rgba(248,113,113,.1);color:var(--err);border:1px solid rgba(248,113,113,.3)}
    .frame{position:relative;background:linear-gradient(135deg,#0b1020,#1f2937);border:2px solid var(--border);border-radius:16px;display:grid;place-items:center;overflow:hidden}
    .frame.ratio-1-1{aspect-ratio:1/1}
    .frame.ratio-3-4{aspect-ratio:3/4}
    .frame.ratio-4-3{aspect-ratio:4/3}
    .frame.ratio-16-9{aspect-ratio:16/9}
    .frame.ratio-9-16{aspect-ratio:9/16}
    .frame.drag{box-shadow:0 0 0 4px var(--ring)}
    .frame img{max-width:100%;max-height:100%;display:none;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#cbd5e1}
    .spinner{width:52px;height:52px;border-radius:50%;border:4px solid #ffffff25;border-top-color:var(--brand);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .progress{position:absolute;left:0;bottom:0;height:4px;width:0;background:linear-gradient(90deg,var(--brand),var(--accent));transition:width .3s ease}
    .history{margin-top:18px}
    .history-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .card-thumb{position:relative;background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .card-thumb img{display:block;width:100%;height:140px;object-fit:cover}
    .thumb-actions{display:flex;gap:6px;position:absolute;right:8px;bottom:8px}
    .rating-system{display:flex;align-items:center;gap:6px;margin:8px 0;font-size:12px}
    .star{cursor:pointer;font-size:18px}
    .star.active{color:var(--accent)}
    .comparison-mode{display:none;margin:18px 0}
    .comparison-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .compare-item img{width:100%;border-radius:12px;border:2px solid var(--border)}
    .collections{margin-top:18px}
    .collection-list{display:flex;gap:8px;flex-wrap:wrap}
    .collection-chip{padding:6px 10px;border:1px solid var(--border);background:var(--surface);border-radius:999px;font-size:12px;cursor:pointer}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="logo"><img src="logo-artemisia.png" alt="Artemisia AI" /></div>
        <div>
          <div class="title">Artemisia Story</div>
          <div class="subtitle">Generatore & Trasformatore AI</div>
        </div>
      </div>
      <div>
        <button class="icon-btn" id="themeBtn" title="Tema">üåó</button>
      </div>
    </header>

    <main class="grid">
      <!-- Colonna sinistra -->
      <section class="card">
        <div class="section-title">‚ú® Prompt</div>

        <!-- Chip stile con negative -->
        <div class="chips" id="styleChips">
          <span class="chip" data-style="modern 2D cartoon, clean cel shading, bold outlines, flat colors"
                data-negative="realistic details, photo, 3D render, stadium, crowd, sports"
                data-preview="/samples/preset-cartoon.jpg">Cartoon</span>
          <span class="chip" data-style="whimsical anime film look, Studio Ghibli style, hand-painted backgrounds, soft pastel palette, gentle lighting"
                data-negative="photo, hyperrealism, 3D render, harsh contrast, sci-fi tech, stadium"
                data-preview="/samples/preset-ghibli.jpg">Ghibli</span>
          <span class="chip" data-style="sacred renaissance painting, dramatic chiaroscuro, warm golden light, oil on canvas texture, classical composition"
                data-negative="sports, stadium, crowd, modern clothes, signage"
                data-preview="/samples/preset-biblico.jpg">Biblico</span>
          <span class="chip" data-style="photorealistic, cinematic lighting"
                data-negative="low-res, noisy, watercolor"
                data-preview="/samples/preset-photo.jpg">Fotorealistico</span>
          <span class="chip" data-style="soft watercolor wash, paper texture"
                data-negative="harsh contrast, photo realism"
                data-preview="/samples/preset-acq.jpg">Acquerello</span>
          <span class="chip" data-style="90s retro aesthetic, light film grain"
                data-negative="ultra modern neon"
                data-preview="/samples/preset-90s.jpg">Vintage '90</span>
        </div>

        <div class="textarea">
          <textarea id="prompt" placeholder="Es.: un angelo al tramonto su una collina, atmosfera serena‚Ä¶"></textarea>
          <div class="counter" id="counter">0/500</div>
        </div>

        <!-- Parametri -->
        <div class="controls">
          <div class="slider">
            <label>Creativit√†:</label>
            <input type="range" id="creativity" min="0" max="100" value="70" oninput="updateCreativity()" />
            <span id="creativityValue">70</span>
          </div>
          <div class="slider">
            <label>Qualit√†:</label>
            <input type="range" id="quality" min="1" max="4" value="2" oninput="updateQuality()" />
            <span id="qualityValue">Standard</span>
          </div>
          <div class="select">
            <select id="variants">
              <option value="1">1 Variante</option>
              <option value="2">2 Varianti</option>
              <option value="4">4 Varianti</option>
            </select>
          </div>
          <div class="select">
            <select id="ratio" onchange="updateRatio()">
              <option value="1-1">1:1</option>
              <option value="3-4">3:4</option>
              <option value="9-16">9:16</option>
              <option value="4-3">4:3</option>
              <option value="16-9">16:9</option>
            </select>
          </div>
        </div>

        <!-- Seed -->
        <div class="controls">
          <div class="select">
            <label>Seed</label>
            <input type="number" id="seed" placeholder="casuale" style="width:120px">
            <button class="btn" onclick="lockSeed()">üîí Blocca</button>
            <button class="btn" onclick="regenSimilar()">‚ôªÔ∏è Simile</button>
          </div>
        </div>

        <!-- Batch + azioni -->
        <div class="controls">
          <div class="select">
            <label>Batch</label>
            <select id="batchSize">
              <option value="1">Genera 1</option>
              <option value="2">Genera 2</option>
              <option value="4">Genera 4</option>
            </select>
          </div>
          <button class="btn" onclick="generateBatch()">Batch Generate</button>
          <button class="btn" onclick="toggleComparison()" id="compareBtn" disabled>Confronta</button>
        </div>

        <div class="btns">
          <button class="btn primary" onclick="generate()" id="generateBtn">üé® Genera</button>
          <button class="btn" onclick="upscale()">üîç Upscale 2√ó</button>
          <button class="btn" onclick="exportMultiple()">üì§ Export</button>
          <button class="btn" onclick="openCollectionsModal()" id="saveToCollectionBtn" disabled>üìÅ Salva in Collezione</button>
        </div>

        <div id="status" class="status"></div>
      </section>

      <!-- Colonna destra -->
      <section class="card">
        <div class="section-title">üñºÔ∏è Anteprima</div>
        <div class="frame ratio-1-1" id="frame" title="Clicca o trascina qui una immagine">
          <img id="resultImg" alt="Risultato" />
          <div class="placeholder" id="placeholder">
            <div class="spinner" id="spinner" style="display:none;margin-bottom:10px"></div>
            <div>Nessuna immagine</div>
          </div>
          <div class="progress" id="progress"></div>
        </div>

        <!-- Confronto -->
        <div class="comparison-mode" id="comparisonMode">
          <div class="section-title">‚öñÔ∏è Confronto risultati</div>
          <div class="comparison-grid">
            <div class="compare-item">
              <img id="compareImg1" alt="A" />
              <div class="btns"><button class="btn" onclick="selectWinner(1)">Preferisci A</button></div>
            </div>
            <div class="compare-item">
              <img id="compareImg2" alt="B" />
              <div class="btns"><button class="btn" onclick="selectWinner(2)">Preferisci B</button></div>
            </div>
          </div>
        </div>

        <!-- Rating -->
        <div class="rating-system" id="ratingSystem" style="display:none;">
          <span>Valuta:</span>
          <span class="star" onclick="rateImage(1)">‚≠ê</span>
          <span class="star" onclick="rateImage(2)">‚≠ê</span>
          <span class="star" onclick="rateImage(3)">‚≠ê</span>
          <span class="star" onclick="rateImage(4)">‚≠ê</span>
          <span class="star" onclick="rateImage(5)">‚≠ê</span>
        </div>

        <!-- Cronologia -->
        <div class="history">
          <div class="section-title">üïò Cronologia</div>
          <div class="history-grid" id="historyGrid">
            <div class="subtitle" style="grid-column:1/-1;text-align:center;padding:16px">Nessuna generazione ancora</div>
          </div>
        </div>

        <!-- Collezioni -->
        <div class="collections">
          <div class="section-title" style="margin-bottom:6px">üìö Collezioni</div>
          <div id="collectionsList" class="collection-list"></div>
        </div>
      </section>
    </main>

    <!-- hidden file input -->
    <input id="fileInput" type="file" accept="image/*" onchange="handleFile(this)" style="display:none" />
    <!-- tooltip -->
    <div id="tooltip" class="tooltip"><img alt="preview"><div class="hint"></div></div>
    <!-- Modal Collezioni -->
    <dialog id="collectionsModal" style="border:none;border-radius:16px;padding:0;max-width:560px;width:92%">
      <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;color:var(--text)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div class="section-title" style="margin:0">üìÅ Gestisci Collezioni</div>
          <button class="icon-btn" onclick="closeCollectionsModal()">‚úï</button>
        </div>
        <div style="display:flex;gap:8px;margin:8px 0 12px">
          <input id="newCollectionName" placeholder="Nuova collezione..." style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text)"/>
          <button class="btn" onclick="createCollection()">Crea</button>
        </div>
        <div id="collectionsModalList" style="max-height:50vh;overflow:auto;display:grid;gap:10px"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn primary" onclick="closeCollectionsModal()">Fatto</button></div>
      </div>
    </dialog>
  </div>

  <script>
    // ======= Stato & endpoint =======
    let lastFile=null,lastImageUrl=null,comparisonImages=[];
    let currentRating=0,batchInProgress=false;
    const history=[];
    const BASE="";
    const GEN_URL=`${BASE}/api/generate`;
    const EDIT_URL=`${BASE}/api/edit`;
    const UPSCALE_URL=`${BASE}/api/upscale`;

    // ======= Tema persistente =======
    const root=document.documentElement;
    document.getElementById('themeBtn').onclick=()=>{
      const t=root.getAttribute('data-theme')==='light'?'dark':'light';
      root.setAttribute('data-theme',t);
      localStorage.setItem('artemisia-theme',t);
    };
    const savedTheme=localStorage.getItem('artemisia-theme'); if(savedTheme) root.setAttribute('data-theme',savedTheme);

    // ======= Tooltip preview (statiche o CDN) =======
    const tooltip=document.getElementById('tooltip');
    document.querySelectorAll('.chip').forEach(chip=>{
      chip.addEventListener('mouseenter',(e)=>{
        const src=chip.dataset.preview; if(!src) return;
        tooltip.querySelector('img').src=src;
        tooltip.querySelector('.hint').textContent=chip.textContent;
        tooltip.style.display='block'; positionTooltip(e);
      });
      chip.addEventListener('mousemove',positionTooltip);
      chip.addEventListener('mouseleave',()=>tooltip.style.display='none');
      chip.addEventListener('click',()=>chip.classList.toggle('active'));
    });
    function positionTooltip(e){ tooltip.style.left=(e.clientX+14)+'px'; tooltip.style.top=(e.clientY+14)+'px'; }

    // ======= UI helpers =======
    function showStatus(msg,err=false){const s=document.getElementById('status');s.style.display='block';s.textContent=msg;s.className=`status ${err?'err':'ok'}`;}
    function hideStatus(){document.getElementById('status').style.display='none';}
    const promptEl=document.getElementById('prompt');
    promptEl.addEventListener('input',()=>{document.getElementById('counter').textContent=`${promptEl.value.length}/500`;});
    function updateCreativity(){document.getElementById('creativityValue').textContent=document.getElementById('creativity').value;}
    function updateQuality(){const v=+document.getElementById('quality').value;document.getElementById('qualityValue').textContent=['Bassa','Standard','Alta','Ultra'][v-1];}
    function updateRatio(){const r=document.getElementById('ratio').value;document.getElementById('frame').className=`frame ratio-${r}`;}

    // ======= Prompt builder =======
    function buildPrompt(){
      const base=promptEl.value.trim();
      const chips=[...document.querySelectorAll('.chip.active')];
      const styles=chips.map(c=>c.dataset.style).filter(Boolean).join('; ');
      return styles?`${base}. Style: ${styles}`:base;
    }
    function buildNegative(){
      const NEG_BASE="text watermark, logo, signature, blurry, low-res, jpeg artifacts, extra fingers, mutated hands";
      const chips=[...document.querySelectorAll('.chip.active')];
      const neg=chips.map(c=>c.dataset.negative).filter(Boolean).join(', ');
      return neg?`${NEG_BASE}, ${neg}`:NEG_BASE;
    }

    // ======= Drag & Drop per edit =======
    const frame=document.getElementById('frame');
    frame.addEventListener('click',()=>document.getElementById('fileInput').click());
    ['dragenter','dragover'].forEach(ev=>frame.addEventListener(ev,e=>{e.preventDefault();frame.classList.add('drag');}));
    ['dragleave','drop'].forEach(ev=>frame.addEventListener(ev,e=>{e.preventDefault();frame.classList.remove('drag');}));
    frame.addEventListener('drop',(e)=>{const f=e.dataTransfer.files?.[0];if(f&&f.type.startsWith('image/')){const dt=new DataTransfer();dt.items.add(f);const input=document.getElementById('fileInput');input.files=dt.files;handleFile(input);}else showStatus('‚ùå Trascina un file immagine valido',true);});

    function handleFile(input){
      const file=input.files[0]; if(!file) return;
      lastFile=file; showStatus(`üìé File ‚Äú${file.name}‚Äù caricato. Scrivi come trasformarlo.`);
      document.getElementById('saveToCollectionBtn').disabled=!lastImageUrl;
    }

    function clearFile(){lastFile=null;document.getElementById('fileInput').value='';hideStatus();}

    // Converti qualsiasi immagine in PNG (RGBA) per evitare errori backend
    async function ensurePNG_RGBA(file){
      return await new Promise((resolve,reject)=>{
        const img=new Image();
        img.onload=()=>{
          try{
            const canvas=document.createElement('canvas');
            canvas.width=img.width; canvas.height=img.height;
            const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0);
            canvas.toBlob(b=>resolve(new File([b],'upload.png',{type:'image/png'})),'image/png',0.95);
          }catch(err){reject(err);}
        };
        img.onerror=()=>reject(new Error('Caricamento immagine fallito'));
        img.src=URL.createObjectURL(file);
      });
    }

    // ======= Batch =======
    async function generateBatch(){
      const n=+document.getElementById('batchSize').value;
      const basePrompt=promptEl.value.trim();
      if(!basePrompt||basePrompt.length<3){showStatus('‚ùå Inserisci un prompt pi√π dettagliato',true);return;}
      batchInProgress=true; comparisonImages=[];
      for(let i=0;i<n;i++){showStatus(`üîÑ Generando ${i+1}/${n}...`); await generate(); if(lastImageUrl) comparisonImages.push(lastImageUrl); if(i<n-1) await new Promise(r=>setTimeout(r,700));}
      batchInProgress=false; if(comparisonImages.length>1){document.getElementById('compareBtn').disabled=false; showStatus(`‚úÖ Batch completato: ${comparisonImages.length} immagini`);}
    }

    // ======= Seed =======
    function lockSeed(){const val=document.getElementById('seed').value; const s=val?parseInt(val,10):Math.floor(Math.random()*1e6); document.getElementById('seed').value=s; showStatus(`üîí Seed bloccato: ${s}`);}
    function regenSimilar(){let s=parseInt(document.getElementById('seed').value||'0',10); if(!s){showStatus('Blocca prima un seed',true);return;} s=s+Math.floor(Math.random()*10+1); document.getElementById('seed').value=s; showStatus(`‚ôªÔ∏è Variazione seed: ${s}`);}

    // ======= Generazione =======
    async function generate(){
      const base=promptEl.value.trim();
      if(!base||base.length<3){showStatus('‚ùå Inserisci un prompt pi√π dettagliato',true);return;}

      const btn=document.getElementById('generateBtn'), spinner=document.getElementById('spinner'),
            ph=document.getElementById('placeholder'), img=document.getElementById('resultImg'),
            bar=document.getElementById('progress');

      btn.disabled=true; hideStatus(); ph.style.display='flex'; spinner.style.display='block'; img.style.display='none'; bar.style.width='0%';
      const prog=setInterval(()=>{const cur=parseInt(bar.style.width)||0; bar.style.width=Math.min(95,cur+Math.random()*10)+'%';},220);

      try{
        const payload={
          prompt:buildPrompt(),
          negative_prompt:buildNegative(),
          seed: document.getElementById('seed').value || undefined,
          creativity:+document.getElementById('creativity').value,
          quality:+document.getElementById('quality').value,
          variants:+document.getElementById('variants').value,
          ratio: document.getElementById('ratio').value
        };

        let res,data;
        if(lastFile){
          const safeFile=await ensurePNG_RGBA(lastFile);
          const fd=new FormData();
          fd.append('image',safeFile);
          Object.entries(payload).forEach(([k,v])=>{if(v!==undefined) fd.append(k,v);});
          res=await fetch(EDIT_URL,{method:'POST',body:fd});
          data=await res.json();
        }else{
          res=await fetch(GEN_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          data=await res.json();
        }

        clearInterval(prog); bar.style.width='100%';
        if(!res.ok) throw new Error(data.error || `Errore ${res.status}`);

        const url=data.image_url; if(!url) throw new Error('Nessun URL immagine ricevuto');
        spinner.style.display='none'; ph.style.display='none';
        img.src=url; img.style.display='block';
        lastImageUrl=url;

        document.getElementById('ratingSystem').style.display='flex';
        document.getElementById('saveToCollectionBtn').disabled=false;

        history.unshift({src:url,caption:payload.prompt,date:new Date(),rating:0});
        if(history.length>12) history.pop(); renderHistory();

        if(!batchInProgress) showStatus('‚úÖ Immagine generata');
      }catch(err){
        clearInterval(prog); spinner.style.display='none'; ph.style.display='flex';
        showStatus('‚ùå '+err.message,true);
      }finally{
        btn.disabled=false; setTimeout(()=>bar.style.width='0%',900);
      }
    }

    // ======= Upscale =======
    async function upscale(){
      if(!lastImageUrl){showStatus('Nessuna immagine',true);return;}
      showStatus('üîç Upscale 2√ó in corso‚Ä¶');
      try{
        const res=await fetch(UPSCALE_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image_url:lastImageUrl,scale:2})});
        const data=await res.json();
        if(!res.ok) throw new Error(data.error||'Errore upscale');
        lastImageUrl=data.image_url; document.getElementById('resultImg').src=lastImageUrl;
        showStatus('‚úÖ Upscale completato');
      }catch(e){showStatus('‚ùå '+e.message,true);}
    }

    // ======= Rating =======
    function rateImage(r){document.querySelectorAll('.star').forEach((s,i)=>s.classList.toggle('active',i<r)); if(history[0]) history[0].rating=r; showStatus(`‚≠ê ${r}/5`);}

    // ======= Confronto =======
    function toggleComparison(){
      const box=document.getElementById('comparisonMode'); const vis=box.style.display!=='none';
      if(vis){ box.style.display='none'; document.getElementById('compareBtn').textContent='Confronta'; }
      else if(comparisonImages.length>=2){ document.getElementById('compareImg1').src=comparisonImages.at(-2); document.getElementById('compareImg2').src=comparisonImages.at(-1); box.style.display='block'; document.getElementById('compareBtn').textContent='Chiudi Confronto'; }
      else showStatus('‚ùå Serve almeno 2 immagini per confrontare',true);
    }
    function selectWinner(w){ const url=w===1?comparisonImages.at(-2):comparisonImages.at(-1); document.getElementById('resultImg').src=url; lastImageUrl=url; showStatus('üèÜ Scelta effettuata'); setTimeout(()=>toggleComparison(),900); }

    // ======= Export =======
    function exportMultiple(){ if(!lastImageUrl){showStatus('Nessuna immagine',true);return;} ['png','jpg','webp'].forEach(f=>downloadAsFormat(lastImageUrl,f)); showStatus('üì§ Export multiplo avviato'); }
    function downloadAsFormat(url,format){ const c=document.createElement('canvas'),ctx=c.getContext('2d'),img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ c.width=img.width; c.height=img.height; ctx.drawImage(img,0,0); const a=document.createElement('a'); a.download=`artemisia-ai.${format}`; a.href=c.toDataURL(`image/${format}`); a.click(); }; img.src=url; }

    // ======= Cronologia =======
    function renderHistory(){
      const grid=document.getElementById('historyGrid');
      if(history.length===0){ grid.innerHTML='<div class="subtitle" style="grid-column:1/-1;text-align:center;padding:16px">Nessuna generazione ancora</div>'; return; }
      grid.innerHTML=history.map((h,i)=>`
        <div class="card-thumb" onclick="setMain('${h.src.replace(/'/g,"\\'")}')">
          <img src="${h.src}" alt="Gen ${i+1}">
          <div class="thumb-actions">
            <button class="icon-btn" onclick="event.stopPropagation(); downloadFromSrc('${h.src.replace(/'/g,"\\'")}')">‚¨áÔ∏è</button>
            <button class="icon-btn" onclick="event.stopPropagation(); reusePrompt(${i})">‚ôªÔ∏è</button>
            ${h.rating?`<span title="Rating: ${h.rating}/5" style="color:var(--accent);font-weight:700">‚≠ê${h.rating}</span>`:''}
          </div>
        </div>
      `).join('');
    }
    function setMain(src){ document.getElementById('resultImg').src=src; lastImageUrl=src; document.getElementById('saveToCollectionBtn').disabled=false; }
    function reusePrompt(i){ if(!history[i]) return; promptEl.value=history[i].caption; document.getElementById('counter').textContent=`${history[i].caption.length}/500`; showStatus('üìù Prompt riutilizzato'); }
    function downloadFromSrc(src){ const a=document.createElement('a'); a.href=src; a.download='artemisia-ai.png'; a.click(); }

    // ======= Collezioni (localStorage) =======
    const LS_KEY='artemisia-collections';
    function getCollections(){ try{return JSON.parse(localStorage.getItem(LS_KEY))||{};}catch{return{};} }
    function setCollections(obj){ localStorage.setItem(LS_KEY,JSON.stringify(obj)); renderCollectionsChips(); }
    function renderCollectionsChips(){
      const wrap=document.getElementById('collectionsList'); const colls=getCollections(); const names=Object.keys(colls);
      wrap.innerHTML = names.length ? names.map(n=>`<button class="collection-chip" onclick="saveCurrentTo('${n}')">${n} (${colls[n].length})</button>`).join('') : '<span class="subtitle">Crea una collezione dal pulsante qui sotto</span>';
    }
    function openCollectionsModal(){
      const dlg=document.getElementById('collectionsModal'); const box=document.getElementById('collectionsModalList'); const colls=getCollections();
      box.innerHTML = Object.entries(colls).map(([name,arr])=>`
        <div class="card" style="padding:12px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <strong>${name}</strong>
            <div style="display:flex;gap:6px">
              <button class="icon-btn" onclick="renameCollection('${name}')">‚úé</button>
              <button class="icon-btn" onclick="deleteCollection('${name}')">üóëÔ∏è</button>
              <button class="icon-btn" onclick="saveCurrentTo('${name}')">‚ûï Aggiungi corrente</button>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:6px">
            ${arr.slice(-8).map(u=>`<img src="${u}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">`).join('')}
          </div>
        </div>`).join('') || '<div class="subtitle">Nessuna collezione. Creane una qui sopra.</div>';
      dlg.showModal();
    }
    function closeCollectionsModal(){ document.getElementById('collectionsModal').close(); }
    function createCollection(){ const name=(document.getElementById('newCollectionName').value||'').trim(); if(!name){ showStatus('‚ùå Inserisci un nome',true); return; } const c=getCollections(); if(c[name]){ showStatus('‚ùå Esiste gi√†',true); return; } c[name]=[]; setCollections(c); document.getElementById('newCollectionName').value=''; openCollectionsModal(); showStatus('üìÅ Collezione creata'); }
    function renameCollection(oldName){ const nn=prompt('Nuovo nome',oldName); if(!nn) return; const c=getCollections(); if(c[nn]){ showStatus('‚ùå Esiste gi√†',true); return; } c[nn]=c[oldName]||[]; delete c[oldName]; setCollections(c); openCollectionsModal(); showStatus('‚úé Rinominata'); }
    function deleteCollection(name){ if(!confirm(`Eliminare ‚Äú${name}‚Äù?`)) return; const c=getCollections(); delete c[name]; setCollections(c); openCollectionsModal(); showStatus('üóëÔ∏è Eliminata'); }
    function saveCurrentTo(name){ if(!lastImageUrl){ showStatus('‚ùå Nessuna immagine',true); return; } const c=getCollections(); c[name]=c[name]||[]; if(!c[name].includes(lastImageUrl)) c[name].push(lastImageUrl); setCollections(c); showStatus(`‚úÖ Salvata in ‚Äú${name}‚Äù`); }

    // ======= Shortcut =======
    document.addEventListener('keydown',e=>{ if((e.metaKey||e.ctrlKey)&&e.key==='Enter'){ e.preventDefault(); generate(); } });

    // ======= Init =======
    (function init(){ document.getElementById('counter').textContent='0/500'; renderCollectionsChips(); })();
  </script>
</body>
</html>
