<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artemisia Story – Generatore & Trasformatore AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* Mantieni qui lo stesso CSS che ti ho già dato (chip, card, grid, frame, ecc.) */
  </style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo"><img src="logo-artemisia.png" alt="logo"></div>
      <div>
        <div class="title">Artemisia Story</div>
        <div style="font-size:13px;color:var(--muted)">Generatore & Trasformatore AI</div>
      </div>
    </div>
    <div>
      <button class="btn" onclick="toggleTheme()">🌗</button>
    </div>
  </header>

  <main class="grid">
    <!-- sinistra -->
    <section class="card">
      <div><strong>✨ Prompt</strong></div>
      <div class="chips">
        <span class="chip" data-style="cartoon, cel shading, bold outlines" data-negative="photo,3d,stadium">Cartoon</span>
        <span class="chip" data-style="Studio Ghibli anime, soft pastel, hand-painted" data-negative="photo,stadium">Ghibli</span>
        <span class="chip" data-style="biblical renaissance painting, chiaroscuro, golden light" data-negative="stadium,crowd">Biblico</span>
      </div>
      <div class="textarea">
        <textarea id="prompt" placeholder="Descrivi la scena..."></textarea>
        <div class="counter" id="counter">0/500</div>
      </div>

      <div class="controls">
        Creatività <input type="range" id="creativity" min="0" max="100" value="70" oninput="updateCreativity()"> <span id="creativityValue">70</span><br>
        Qualità <input type="range" id="quality" min="1" max="4" value="2" oninput="updateQuality()"> <span id="qualityValue">Standard</span>
      </div>

      <div class="controls">
        Seed <input type="number" id="seed" placeholder="casuale" style="width:100px">
        <button class="btn" onclick="lockSeed()">🔒 Blocca</button>
        <button class="btn" onclick="regenSimilar()">♻️ Simile</button>
      </div>

      <div class="btns">
        <button class="btn primary" onclick="generate()" id="generateBtn">🎨 Genera</button>
        <button class="btn" onclick="upscale()">🔍 Upscale</button>
        <button class="btn" onclick="exportMultiple()">📤 Export</button>
      </div>

      <div class="status" id="status"></div>
    </section>

    <!-- destra -->
    <section class="card">
      <div><strong>🖼️ Anteprima</strong></div>
      <div class="frame"><img id="resultImg"><div id="placeholder">Nessuna immagine</div></div>

      <div id="ratingSystem" style="margin-top:10px;display:none">
        Valuta:
        <span class="star" onclick="rateImage(1)">⭐</span>
        <span class="star" onclick="rateImage(2)">⭐</span>
        <span class="star" onclick="rateImage(3)">⭐</span>
        <span class="star" onclick="rateImage(4)">⭐</span>
        <span class="star" onclick="rateImage(5)">⭐</span>
      </div>

      <div style="margin-top:20px"><strong>🕘 Cronologia</strong></div>
      <div class="history-grid" id="historyGrid"></div>
    </section>
  </main>
</div>

<script>
const BASE = "";
const GEN_URL = `${BASE}/api/generate`;
const EDIT_URL = `${BASE}/api/edit`;
const UPSCALE_URL = `${BASE}/api/upscale`;

let lastImageUrl=null, lockedSeed=null, history=[];

// Prompt builder
function buildPrompt(){
  const base=document.getElementById('prompt').value.trim();
  const chips=[...document.querySelectorAll('.chip.active')];
  const styles=chips.map(c=>c.dataset.style).join('; ');
  return styles?`${base}. Style: ${styles}`:base;
}
function buildNegative(){
  const base="text watermark,logo,blurry";
  const chips=[...document.querySelectorAll('.chip.active')];
  const neg=chips.map(c=>c.dataset.negative).join(',');
  return `${base},${neg}`;
}

// Chip toggle
document.querySelectorAll('.chip').forEach(c=>c.onclick=()=>c.classList.toggle('active'));

// Counter
document.getElementById('prompt').addEventListener('input',()=>{
  const len=prompt.value.length;
  document.getElementById('counter').textContent=`${len}/500`;
});

// Status
function showStatus(msg,err=false){
  const st=document.getElementById('status');
  st.style.display='block'; st.textContent=msg;
  st.className=`status ${err?'err':'ok'}`;
}

// Seed
function lockSeed(){lockedSeed=document.getElementById('seed').value||Math.floor(Math.random()*999999);showStatus("🔒 Seed:"+lockedSeed);}
function regenSimilar(){if(!lockedSeed){showStatus("Blocca prima un seed",true);return;}lockedSeed=parseInt(lockedSeed)+Math.floor(Math.random()*10+1);document.getElementById('seed').value=lockedSeed;showStatus("♻️ Seed:"+lockedSeed);}

// Generate (real call)
async function generate(){
  const payload={
    prompt:buildPrompt(),
    negative_prompt:buildNegative(),
    seed:lockedSeed||undefined,
    creativity:+document.getElementById('creativity').value,
    quality:+document.getElementById('quality').value,
    variants:1
  };
  showStatus("✨ Generazione...");

  try {
    const res=await fetch(GEN_URL,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const data=await res.json();
    if(!res.ok) throw new Error(data.error||"Errore server");

    lastImageUrl=data.image_url;
    document.getElementById('resultImg').src=lastImageUrl;
    document.getElementById('resultImg').style.display='block';
    document.getElementById('placeholder').style.display='none';
    addHistory(lastImageUrl,payload.prompt);
    document.getElementById('ratingSystem').style.display='block';
    showStatus("✅ Immagine generata");
  } catch(e){
    showStatus("❌ "+e.message,true);
  }
}

// Upscale (real call)
async function upscale(){
  if(!lastImageUrl){showStatus("Nessuna immagine",true);return;}
  showStatus("🔍 Upscale...");
  try {
    const res=await fetch(UPSCALE_URL,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({image_url:lastImageUrl,scale:2})
    });
    const data=await res.json();
    if(!res.ok) throw new Error(data.error||"Errore upscale");
    lastImageUrl=data.image_url;
    document.getElementById('resultImg').src=lastImageUrl;
    showStatus("✅ Upscale completato");
  } catch(e){showStatus("❌ "+e.message,true);}
}

// History
function addHistory(src,caption){history.unshift({src,caption,rating:0});renderHistory();}
function renderHistory(){
  const g=document.getElementById('historyGrid');
  g.innerHTML=history.map((h,i)=>`
    <div class="card-thumb">
      <img src="${h.src}">
      <div class="thumb-actions">
        <button onclick="reusePrompt(${i})">♻️</button>
      </div>
    </div>`).join('');
}
function reusePrompt(i){document.getElementById('prompt').value=history[i].caption;showStatus("Prompt riusato");}

// Rating
function rateImage(r){
  document.querySelectorAll('.star').forEach((s,i)=>s.classList.toggle('active',i<r));
  if(history[0])history[0].rating=r;
  showStatus("⭐ "+r+"/5");
}

// Export
function exportMultiple(){if(!lastImageUrl){showStatus("Nessuna immagine",true);return;}
  ["png","jpg","webp"].forEach(fmt=>downloadAsFormat(lastImageUrl,fmt));
}
function downloadAsFormat(url,fmt){
  const a=document.createElement('a');
  a.href=url; a.download="artemisia."+fmt; a.click();
}

// Helpers
function updateCreativity(){document.getElementById('creativityValue').textContent=document.getElementById('creativity').value;}
function updateQuality(){const v=document.getElementById('quality').value;const lbl=['Bassa','Standard','Alta','Ultra'];document.getElementById('qualityValue').textContent=lbl[v-1];}
function toggleTheme(){const root=document.documentElement;root.setAttribute('data-theme',root.getAttribute('data-theme')==='light'?'dark':'light');}

// Shortcut
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){generate();}});
</script>
</body>
</html>
