<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artemisia Story ¬∑ Generatore & Trasformatore di immagini AI</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé®</text></svg>" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-start:#0f172a; --bg-end:#1e1b4b; --card:#0b1020cc; --text:#e2e8f0; --muted:#94a3b8;
      --brand:#6366f1; --brand-2:#8b5cf6; --accent:#f8c045; --ring:rgba(99,102,241,.35);
      --ok:#34d399; --warn:#f59e0b; --err:#f87171; --surface:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.14); --chip:rgba(148,163,184,.12); --shadow:0 18px 60px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg-start:#e8eef8; --bg-end:#dfe4ff; --card:#ffffffee; --text:#0f172a; --muted:#475569;
      --surface:#f8fafc; --border:rgba(2,6,23,.12); --chip:rgba(2,6,23,.06); --shadow:0 18px 50px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background:
        radial-gradient(1000px 600px at -10% -10%, #0ea5e980, transparent 60%),
        radial-gradient(800px 500px at 110% 10%, #a78bfa66, transparent 60%),
        linear-gradient(135deg, var(--bg-start), var(--bg-end));
      overflow-x:hidden;
    }
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:22px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:48px;height:48px;border-radius:14px;display:grid;place-items:center;box-shadow:var(--shadow);background:var(--surface);font-size:24px}
    .title{font-size:28px;font-weight:800;letter-spacing:.2px}
    .subtitle{font-size:14px;color:var(--muted)}
    .actions{display:flex;align-items:center;gap:8px}
    .icon-btn{border:1px solid var(--border);background:var(--surface);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;transition:all .2s ease}
    .icon-btn:hover{transform:translateY(-1px);border-color:var(--accent)}

    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:20px}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:22px}
    .section-title{display:flex;align-items:center;gap:8px;font-weight:700;margin-bottom:10px}
    .section-title .emoji{font-size:20px}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
    .chip{position:relative;padding:8px 12px;border:1px solid var(--border);background:var(--chip);border-radius:999px;font-size:12px;cursor:pointer;user-select:none;transition:all .2s ease}
    .chip.active{outline:2px solid var(--ring);border-color:transparent;background:rgba(99,102,241,.20)}
    .chip:hover{background:rgba(99,102,241,.12);border-color:var(--brand)}
    .chip.business{border-color:rgba(34,197,94,.28);background:rgba(34,197,94,.10)}
    .chip.business.active{background:rgba(34,197,94,.18);outline-color:rgba(34,197,94,.45)}
    .chip.creative{border-color:rgba(245,158,11,.28);background:rgba(245,158,11,.10)}
    .chip.creative.active{background:rgba(245,158,11,.18);outline-color:rgba(245,158,11,.45)}
    .chip.photo{border-color:rgba(59,130,246,.28);background:rgba(59,130,246,.10)}
    .chip.photo.active{background:rgba(59,130,246,.18);outline-color:rgba(59,130,246,.45)}

    .controls{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0}
    .select,.slider{display:flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--surface);padding:10px 12px;border-radius:12px}
    .select select, .select input{background:transparent;border:none;color:var(--text);font-size:14px}
    .select select:focus, .select input:focus{outline:none}
    .slider input{accent-color:var(--brand)}
    .slider span{font-size:12px;color:var(--muted);min-width:50px}

    .textarea{position:relative}
    textarea{width:100%;min-height:120px;resize:vertical;border:2px solid transparent;border-radius:16px;padding:16px 18px;background:var(--surface);color:var(--text);line-height:1.55;font-size:15px}
    textarea:focus{outline:none;box-shadow:0 0 0 4px var(--ring);border-color:transparent}
    textarea::placeholder{color:var(--muted);opacity:.85}
    .counter{position:absolute;right:12px;bottom:8px;font-size:12px;color:var(--muted)}

    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid var(--border);cursor:pointer;transition:transform .12s ease, box-shadow .2s ease;background:var(--surface);color:var(--text);text-decoration:none;font-weight:700;font-size:14px}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none!important}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent;color:#fff;box-shadow:0 10px 24px rgba(99,102,241,.45)}
    .btn.primary:not(:disabled):hover{transform:translateY(-2px);box-shadow:0 16px 36px rgba(99,102,241,.55)}
    .btn.outline:not(:disabled):hover{border-color:var(--accent);background:rgba(248,192,69,.10)}

    .status{margin-top:12px;padding:12px 16px;border-radius:12px;font-size:14px;font-weight:600;display:none;align-items:center;gap:10px}
    .status.ok{background:rgba(52,211,153,.10);color:var(--ok);border:1px solid rgba(52,211,153,.30)}
    .status.err{background:rgba(248,113,113,.10);color:var(--err);border:1px solid rgba(248,113,113,.30)}

    .frame{position:relative;background:linear-gradient(135deg,#0b1020,#1f2937);border:2px dashed var(--border);border-radius:18px;display:grid;place-items:center;overflow:hidden;transition:border-color .2s ease, box-shadow .2s ease}
    .frame.ratio-1-1{aspect-ratio:1/1}
    .frame.ratio-3-4{aspect-ratio:3/4}
    .frame.ratio-4-3{aspect-ratio:4/3}
    .frame.ratio-16-9{aspect-ratio:16/9}
    .frame.ratio-9-16{aspect-ratio:9/16}
    .frame.drag{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
    .frame img{max-width:100%;max-height:100%;display:none;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .frame img.show{display:block;animation:fadeIn .35s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:scale(.98)} to{opacity:1;transform:scale(1)}}
    .placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:#cbd5e1;opacity:.9;text-align:center;padding:28px}
    .spinner{width:54px;height:54px;border-radius:50%;border:4px solid #ffffff20;border-top-color:var(--brand);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .progress{position:absolute;left:0;bottom:0;height:4px;width:0;background:linear-gradient(90deg,var(--brand),var(--accent));transition:width .3s ease;border-radius:0 0 16px 16px}

    .history{margin-top:18px}
    .history-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .card-thumb{position:relative;background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;transition:transform .15s ease, border-color .2s ease;cursor:pointer}
    .card-thumb:hover{transform:translateY(-2px);border-color:var(--accent)}
    .card-thumb img{display:block;width:100%;height:140px;object-fit:cover;transition:transform .3s ease}
    .card-thumb:hover img{transform:scale(1.05)}
    .thumb-actions{display:flex;gap:6px;position:absolute;right:8px;bottom:8px;opacity:0;transition:opacity .2s ease}
    .card-thumb:hover .thumb-actions{opacity:1}
    .thumb-btn{padding:4px 6px;background:rgba(0,0,0,.7);color:#fff;border:none;border-radius:6px;font-size:10px;cursor:pointer}
    .small{font-size:12px;color:var(--muted)}

    .comparison-mode{display:none;margin:20px 0}
    .comparison-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .compare-item{text-align:center}
    .compare-item img{width:100%;border-radius:12px;border:2px solid var(--border)}
    .compare-controls{margin-top:8px}

    .rating-system{display:flex;align-items:center;gap:8px;margin:8px 0;font-size:12px}
    .stars{display:flex;gap:4px}
    .star{cursor:pointer;transition:transform .15s ease;font-size:16px}
    .star:hover{transform:scale(1.2)}
    .star.active{color:var(--accent)}

    .help-modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;z-index:100;padding:20px;overflow-y:auto}
    .help-content{background:var(--card);border-radius:20px;max-width:600px;margin:auto;padding:30px;border:1px solid var(--border)}
    .help-close{float:right;background:none;border:none;color:var(--text);font-size:24px;cursor:pointer}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="logo">üé®</div>
        <div>
          <div class="title">Artemisia Story</div>
          <div class="subtitle">Generatore & Trasformatore di immagini AI</div>
        </div>
      </div>
      <div class="actions">
        <button class="icon-btn" id="themeBtn" title="Tema">üåó</button>
        <button class="icon-btn" onclick="showHelp()" title="Guida">‚ùî</button>
      </div>
    </header>

    <main class="grid">
      <!-- Colonna sinistra -->
      <section class="card">
        <div class="section-title"><span class="emoji">‚ú®</span><span>Scrivi il tuo prompt</span></div>

        <!-- Preset con stile/negative -->
        <div class="chips" id="styleChips">
          <span class="chip" data-key="cartoon"
                data-style="modern 2D cartoon, clean cel shading, bold outlines, flat colors, playful composition"
                data-negative="realistic photo, 3D render, stadium, crowd, sports">Cartoon</span>

          <span class="chip" data-key="ghibli"
                data-style="whimsical anime film look, Studio Ghibli style, hand-painted backgrounds, soft pastel palette, gentle lighting"
                data-negative="photo, hyperrealism, 3D render, harsh contrast, sci-fi tech, stadium">Ghibli</span>

          <span class="chip" data-key="biblico"
                data-style="sacred renaissance painting, dramatic chiaroscuro, warm golden light, oil on canvas texture, classical composition"
                data-negative="sports, stadium, crowd cheering, football, signage, modern clothes">Biblico</span>
        </div>

        <!-- Business / Arte / Fotografia -->
        <div class="section-title" style="margin-top:10px"><span class="emoji">üéØ</span><span>Business & Marketing</span></div>
        <div class="chips">
          <span class="chip business" data-style="minimal corporate branding, clean layout, strong typographic hierarchy"
                data-negative="busy background, clutter, gradients">Logo Business</span>
          <span class="chip business" data-style="product hero shot, studio softbox lighting, seamless background"
                data-negative="busy background, reflections, watermark">Prodotto</span>
          <span class="chip business" data-style="social media graphic, vibrant colors, bold composition, high contrast"
                data-negative="photo watermark, logo noise">Social Post</span>
        </div>

        <div class="section-title" style="margin-top:10px"><span class="emoji">üé®</span><span>Arte & Creativit√†</span></div>
        <div class="chips">
          <span class="chip creative" data-style="epic fantasy concept art, cinematic lighting, volumetric fog"
                data-negative="sci-fi tech, modern signage">Fantasy Art</span>
          <span class="chip creative" data-style="children book illustration, soft rounded shapes, pastel colors"
                data-negative="harsh contrast, photo realism">Per Bambini</span>
          <span class="chip creative" data-style="modern abstract art, geometric shapes, gradient fields, dynamic composition"
                data-negative="figurative realism, text">Arte Astratta</span>
        </div>

        <div class="section-title" style="margin-top:10px"><span class="emoji">üì∏</span><span>Fotografia</span></div>
        <div class="chips">
          <span class="chip photo" data-style="portrait 85mm, soft cinematic lighting, natural bokeh, high resolution"
                data-negative="overexposed, harsh shadows, watermark">Ritratto Pro</span>
          <span class="chip photo" data-style="landscape golden hour, saturated colors, panoramic composition"
                data-negative="haze, washed out, watermark">Paesaggio</span>
        </div>

        <!-- Parametri -->
        <div class="section-title" style="margin-top:14px"><span class="emoji">‚öôÔ∏è</span><span>Parametri</span></div>
        <div class="controls">
          <div class="slider">
            <label>Creativit√†:</label>
            <input type="range" id="creativity" min="0" max="100" value="70" oninput="updateCreativity()" />
            <span id="creativityValue">70</span>
          </div>
          <div class="slider">
            <label>Qualit√†:</label>
            <input type="range" id="quality" min="1" max="4" value="2" oninput="updateQuality()" />
            <span id="qualityValue">Standard</span>
          </div>
          <div class="select">
            <select id="variants">
              <option value="1">1 Variante</option>
              <option value="2">2 Varianti</option>
              <option value="4">4 Varianti</option>
            </select>
          </div>
          <div class="select">
            <select id="ratio" onchange="updateRatio()">
              <option value="1-1">1:1 (Quadrato)</option>
              <option value="3-4">3:4 (Ritratto)</option>
              <option value="9-16">9:16 (Verticale)</option>
              <option value="4-3">4:3 (Orizzontale)</option>
              <option value="16-9">16:9 (Wide)</option>
            </select>
          </div>
        </div>

        <!-- Prompt -->
        <div class="textarea">
          <textarea id="prompt" placeholder="Es.: Un angelo al tramonto su una collina, atmosfera serena, composizione armoniosa." oninput="updateCounter()"></textarea>
          <div class="counter" id="counter">0/500</div>
        </div>

        <!-- Seed & azioni -->
        <div class="controls">
          <div class="select" style="gap:6px">
            <label>Seed:</label>
            <input type="number" id="seed" value="" placeholder="casuale" style="width:110px">
            <button class="btn outline" onclick="lockSeed()">üîí Blocca</button>
            <button class="btn outline" onclick="regenSimilar()">‚ôªÔ∏è Rigenera simile</button>
          </div>
        </div>

        <!-- Batch & confronto -->
        <div class="controls">
          <div class="select">
            <select id="batchSize">
              <option value="1">Genera 1</option>
              <option value="2">Genera 2</option>
              <option value="4">Genera 4</option>
            </select>
          </div>
          <button class="btn outline" onclick="generateBatch()">Batch Generate</button>
          <button class="btn outline" onclick="toggleComparison()" id="compareBtn" disabled>Confronta A/B</button>
        </div>

        <!-- Pulsanti principali -->
        <div class="btns">
          <button class="btn primary" onclick="generate()" id="generateBtn">üé® Genera</button>
          <button class="btn outline" onclick="surprise()">üé≤ Ispirami</button>
          <button class="btn outline" onclick="downloadImage()" id="downloadBtn" disabled>üì• Scarica PNG</button>
          <button class="btn outline" onclick="exportMultiple()" id="exportBtn" disabled>üì§ Export Multi</button>
          <button class="btn outline" onclick="upscale2x()" id="up2xBtn" disabled>üîç Upscale 2√ó</button>
          <button class="btn outline" onclick="upscale4x()" id="up4xBtn" disabled>üîé Upscale 4√ó</button>
        </div>

        <!-- Rating -->
        <div class="rating-system" id="ratingSystem" style="display:none;">
          <span>Valuta risultato:</span>
          <div class="stars" id="starRating">
            <span class="star" onclick="rateImage(1)">‚≠ê</span>
            <span class="star" onclick="rateImage(2)">‚≠ê</span>
            <span class="star" onclick="rateImage(3)">‚≠ê</span>
            <span class="star" onclick="rateImage(4)">‚≠ê</span>
            <span class="star" onclick="rateImage(5)">‚≠ê</span>
          </div>
        </div>

        <div id="status" class="status"></div>
      </section>

      <!-- Colonna destra -->
      <section class="card">
        <div class="section-title"><span class="emoji">üñºÔ∏è</span><span>Anteprima</span></div>
        <div class="frame ratio-1-1" id="frame" title="Trascina qui un'immagine (opzionale)" onclick="document.getElementById('fileInput').click()">
          <img id="resultImg" alt="Risultato" />
          <div class="placeholder" id="placeholder">
            <div class="spinner" id="spinner" style="display:none"></div>
            <div class="ph-content" id="phContent">
              <div style="font-weight:800;opacity:.95;font-size:18px">Nessuna immagine ancora</div>
              <div class="small">Scrivi un prompt e premi "Genera"</div>
            </div>
          </div>
          <div class="progress" id="progress"></div>
        </div>

        <!-- Confronto A/B -->
        <div class="comparison-mode" id="comparisonMode">
          <div class="section-title"><span class="emoji">‚öñÔ∏è</span><span>Confronto Risultati</span></div>
          <div class="comparison-grid">
            <div class="compare-item">
              <img id="compareImg1" alt="A" />
              <div class="compare-controls">
                <button class="btn outline" onclick="selectWinner(1)">Preferisci A</button>
              </div>
            </div>
            <div class="compare-item">
              <img id="compareImg2" alt="B" />
              <div class="compare-controls">
                <button class="btn outline" onclick="selectWinner(2)">Preferisci B</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Cronologia -->
        <div class="history">
          <div class="section-title"><span class="emoji">üïò</span><span>Cronologia</span></div>
          <div class="history-grid" id="historyGrid">
            <div class="small" style="grid-column:1/-1;text-align:center;padding:20px">Nessuna generazione ancora</div>
          </div>
        </div>

        <div class="tips" style="margin-top:16px;padding:18px;border-left:3px solid var(--brand);background:linear-gradient(0deg,transparent,rgba(99,102,241,.10));border-radius:12px">
          <strong>üí° Suggerimenti rapidi</strong>
          <ul style="margin:.5rem 0 0 1.2rem; line-height:1.7; font-size:14px">
            <li>Usa i preset con **style/negative** per risultati coerenti</li>
            <li>Blocca un **seed** per esplorazioni consistenti</li>
            <li>Batch + Confronto A/B per scegliere il migliore</li>
            <li>Export in **PNG/JPG/WebP** in un click</li>
          </ul>
        </div>
      </section>
    </main>
  </div>

  <!-- File input nascosto -->
  <input id="fileInput" type="file" accept="image/*" onchange="handleFile(this)" style="display:none" />

  <!-- Modal guida -->
  <div id="helpModal" class="help-modal">
    <div class="help-content">
      <button class="help-close" onclick="hideHelp()">&times;</button>
      <h2>üé® Guida Artemisia Story</h2>
      <h3>Come usare:</h3>
      <ol>
        <li><strong>Seleziona preset:</strong> Clicca sui chip per attivare stili predefiniti</li>
        <li><strong>Scrivi prompt:</strong> Descrivi l'immagine che vuoi generare</li>
        <li><strong>Imposta parametri:</strong> Creativit√†, qualit√†, formato</li>
        <li><strong>Genera:</strong> Clicca "Genera" e attendi il risultato</li>
      </ol>
      <h3>Funzioni avanzate:</h3>
      <ul>
        <li><strong>Seed:</strong> Blocca per risultati coerenti</li>
        <li><strong>Batch:</strong> Genera pi√π varianti insieme</li>
        <li><strong>A/B Test:</strong> Confronta due risultati</li>
        <li><strong>Upscale:</strong> Migliora la risoluzione</li>
      </ul>
    </div>
  </div>

  <script>
    // ===== Config =====
    const USE_MOCK = true;
    const BASE = '';
    const GEN_URL = `${BASE}/api/generate`;
    const EDIT_URL = `${BASE}/api/edit`;
    const UPSCALE_URL = `${BASE}/api/upscale`;

    // ===== Stato =====
    let lastImageUrl = null;
    let lastFile = null;
    let lockedSeed = null;
    let batchInProgress = false;
    let comparisonImages = [];
    let currentRating = 0;
    const history = JSON.parse(localStorage.getItem('artemisia-history') || '[]');

    // ===== Tema =====
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('artemisia-theme');
    if (savedTheme) root.setAttribute('data-theme', savedTheme);
    
    document.getElementById('themeBtn').onclick = () => {
      const theme = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', theme);
      localStorage.setItem('artemisia-theme', theme);
    };

    // ===== Chip Management =====
    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        chip.classList.toggle('active');
      });
    });

    // ===== Helper Functions =====
    function showStatus(msg, isError = false) {
      const status = document.getElementById('status');
      status.style.display = 'flex';
      status.className = `status ${isError ? 'err' : 'ok'}`;
      status.innerHTML = msg;
    }

    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }

    function updateCounter() {
      const prompt = document.getElementById('prompt');
      const counter = document.getElementById('counter');
      const length = prompt.value.length;
      counter.textContent = `${length}/500`;
      counter.style.color = length > 500 ? 'var(--err)' : 'var(--muted)';
    }

    function updateCreativity() {
      const creativity = document.getElementById('creativity');
      const value = document.getElementById('creativityValue');
      value.textContent = creativity.value;
    }

    function updateQuality() {
      const quality = document.getElementById('quality');
      const value = document.getElementById('qualityValue');
      const labels = ['Basso', 'Standard', 'Alto', 'Ultra'];
      value.textContent = labels[quality.value - 1];
    }

    function updateRatio() {
      const ratio = document.getElementById('ratio').value;
      const frame = document.getElementById('frame');
      frame.className = frame.className.replace(/ratio-\S+/, `ratio-${ratio}`);
    }

    // ===== File Handling =====
    function handleFile(input) {
      const file = input.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        showStatus('‚ö†Ô∏è Seleziona solo file immagine', true);
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        lastFile = e.target.result;
        const img = document.getElementById('resultImg');
        img.src = e.target.result;
        img.classList.add('show');
        document.getElementById('placeholder').style.display = 'none';
        enableButtons();
        showStatus('‚úÖ Immagine caricata con successo');
      };
      reader.readAsDataURL(file);
    }

    // ===== Drag & Drop =====
    const frame = document.getElementById('frame');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      frame.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      frame.addEventListener(eventName, () => frame.classList.add('drag'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      frame.addEventListener(eventName, () => frame.classList.remove('drag'), false);
    });

    frame.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const input = document.getElementById('fileInput');
        input.files = files;
        handleFile(input);
      }
    });

    // ===== Generate Functions =====
    async function generate() {
      const prompt = document.getElementById('prompt').value.trim();
      if (!prompt) {
        showStatus('‚ö†Ô∏è Inserisci un prompt prima di generare', true);
        return;
      }

      if (prompt.length > 500) {
        showStatus('‚ö†Ô∏è Il prompt √® troppo lungo (max 500 caratteri)', true);
        return;
      }

      const generateBtn = document.getElementById('generateBtn');
      const originalText = generateBtn.innerHTML;
      
      try {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '‚è≥ Generando...';
        
        showLoading();
        hideStatus();

        const payload = await buildPayload(prompt);
        
        if (USE_MOCK) {
          await mockGenerate(payload);
        } else {
          await realGenerate(payload);
        }

      } catch (error) {
        console.error('Generation error:', error);
        showStatus('‚ùå Errore durante la generazione: ' + error.message, true);
        hideLoading();
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = originalText;
      }
    }

    async function buildPayload(prompt) {
      // Raccogli stili attivi
      const activeChips = document.querySelectorAll('.chip.active');
      let stylePrompts = [];
      let negativePrompts = [];

      activeChips.forEach(chip => {
        if (chip.dataset.style) stylePrompts.push(chip.dataset.style);
        if (chip.dataset.negative) negativePrompts.push(chip.dataset.negative);
      });

      // Costruisci prompt finale
      let finalPrompt = prompt;
      if (stylePrompts.length > 0) {
        finalPrompt += ', ' + stylePrompts.join(', ');
      }

      return {
        prompt: finalPrompt,
        negative_prompt: negativePrompts.join(', '),
        creativity: parseInt(document.getElementById('creativity').value),
        quality: parseInt(document.getElementById('quality').value),
        variants: parseInt(document.getElementById('variants').value),
        ratio: document.getElementById('ratio').value,
        seed: document.getElementById('seed').value || null,
        image: lastFile || null
      };
    }

    async function mockGenerate(payload) {
      // Simula progresso
      await simulateProgress();
      
      // Genera immagine mock
      const mockImage = generateMockImage(payload.ratio);
      displayResult(mockImage, payload);
      
      // Genera seed se non specificato
      const seed = payload.seed || Math.floor(Math.random() * 999999999);
      document.getElementById('seed').value = seed;
      
      showStatus('‚úÖ Immagine generata con successo!');
      addToHistory(mockImage, payload.prompt, seed);
    }

    async function realGenerate(payload) {
      const response = await fetch(GEN_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const result = await response.json();
      if (result.error) {
        throw new Error(result.error);
      }

      displayResult(result.image_url, payload);
      showStatus('‚úÖ Immagine generata con successo!');
      addToHistory(result.image_url, payload.prompt, result.seed);
    }

    function generateMockImage(ratio) {
      const ratioMap = {
        '1-1': '512x512',
        '3-4': '384x512', 
        '9-16': '288x512',
        '4-3': '512x384',
        '16-9': '512x288'
      };
      
      const size = ratioMap[ratio] || '512x512';
      const seed = Math.floor(Math.random() * 1000);
      return `https://picsum.photos/seed/${seed}/${size}`;
    }

    function displayResult(imageUrl, payload) {
      lastImageUrl = imageUrl;
      const img = document.getElementById('resultImg');
      img.src = imageUrl;
      img.classList.add('show');
      
      hideLoading();
      enableButtons();
      showRatingSystem();
    }

    function showLoading() {
      document.getElementById('placeholder').style.display = 'none';
      document.getElementById('spinner').style.display = 'block';
      document.getElementById('phContent').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('placeholder').style.display = 'none';
    }

    function enableButtons() {
      document.getElementById('downloadBtn').disabled = false;
      document.getElementById('up2xBtn').disabled = false;
      document.getElementById('up4xBtn').disabled = false;
      document.getElementById('exportBtn').disabled = false;
    }

    async function simulateProgress() {
      const progress = document.getElementById('progress');
      let width = 0;
      
      return new Promise(resolve => {
        const interval = setInterval(() => {
          width += Math.random() * 15;
          if (width >= 100) {
            width = 100;
            clearInterval(interval);
            setTimeout(() => {
              progress.style.width = '0%';
              resolve();
            }, 300);
          }
          progress.style.width = width + '%';
        }, 200);
      });
    }

    // ===== Batch Generation =====
    async function generateBatch() {
      const batchSize = parseInt(document.getElementById('batchSize').value);
      const prompt = document.getElementById('prompt').value.trim();
      
      if (!prompt) {
        showStatus('‚ö†Ô∏è Inserisci un prompt per la generazione batch', true);
        return;
      }

      if (batchInProgress) return;
      batchInProgress = true;

      try {
        showStatus(`üîÑ Generazione batch di ${batchSize} immagini...`);
        const results = [];
        
        for (let i = 0; i < batchSize; i++) {
          showStatus(`üîÑ Generando immagine ${i + 1}/${batchSize}...`);
          const payload = await buildPayload(prompt);
          
          if (USE_MOCK) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            const mockImage = generateMockImage(payload.ratio);
            results.push({ url: mockImage, seed: Math.floor(Math.random() * 999999999) });
          } else {
            // Implementazione reale qui
          }
        }

        // Mostra primo risultato
        if (results.length > 0) {
          displayResult(results[0].url, {});
          results.forEach(result => {
            addToHistory(result.url, prompt, result.seed);
          });
        }

        // Abilita confronto se ci sono almeno 2 risultati
        if (results.length >= 2) {
          comparisonImages = results.slice(0, 2);
          document.getElementById('compareBtn').disabled = false;
        }

        showStatus(`‚úÖ Generazione batch completata: ${results.length} immagini`);
        
      } catch (error) {
        showStatus('‚ùå Errore nella generazione batch: ' + error.message, true);
      } finally {
        batchInProgress = false;
      }
    }

    // ===== Comparison Mode =====
    function toggleComparison() {
      const comparisonMode = document.getElementById('comparisonMode');
      const isVisible = comparisonMode.style.display !== 'none';
      
      if (!isVisible && comparisonImages.length >= 2) {
        document.getElementById('compareImg1').src = comparisonImages[0].url;
        document.getElementById('compareImg2').src = comparisonImages[1].url;
        comparisonMode.style.display = 'block';
        document.getElementById('compareBtn').textContent = 'Chiudi Confronto';
      } else {
        comparisonMode.style.display = 'none';
        document.getElementById('compareBtn').textContent = 'Confronta A/B';
      }
    }

    function selectWinner(choice) {
      const winner = comparisonImages[choice - 1];
      displayResult(winner.url, {});
      showStatus(`‚úÖ Hai scelto l'immagine ${choice === 1 ? 'A' : 'B'}`);
      toggleComparison();
    }

    // ===== Utility Functions =====
    function surprise() {
      const prompts = [
        "Un drago dorato che vola sopra un castello medievale al tramonto",
        "Una foresta incantata con creature magiche e luci fatate",
        "Un astronauta che cammina su un pianeta alieno colorato",
        "Una citt√† futuristica con grattacieli di cristallo",
        "Un giardino zen con cascata e fiori di ciliegio",
        "Una nave pirata che naviga in un mare tempestoso",
        "Un villaggio delle fate costruito in un albero gigante",
        "Un robot gentile che gioca con i bambini in un parco",
        "Una biblioteca magica con libri che volano",
        "Un mercato orientale pieno di spezie e colori"
      ];
      
      const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
      document.getElementById('prompt').value = randomPrompt;
      updateCounter();
      
      // Attiva un preset casuale
      const chips = document.querySelectorAll('.chip');
      chips.forEach(chip => chip.classList.remove('active'));
      const randomChip = chips[Math.floor(Math.random() * chips.length)];
      randomChip.classList.add('active');
      
      showStatus('üé≤ Prompt ispirazionale generato!');
    }

    function lockSeed() {
      const seed = document.getElementById('seed').value;
      if (seed) {
        lockedSeed = seed;
        showStatus(`üîí Seed ${seed} bloccato per generazioni future`);
      } else {
        const newSeed = Math.floor(Math.random() * 999999999);
        document.getElementById('seed').value = newSeed;
        lockedSeed = newSeed;
        showStatus(`üîí Nuovo seed ${newSeed} generato e bloccato`);
      }
    }

    function regenSimilar() {
      if (lockedSeed) {
        document.getElementById('seed').value = lockedSeed;
        generate();
      } else {
        showStatus('‚ö†Ô∏è Nessun seed bloccato. Usa "Blocca Seed" prima', true);
      }
    }

    // ===== Download & Export =====
    function downloadImage() {
      if (!lastImageUrl) {
        showStatus('‚ö†Ô∏è Nessuna immagine da scaricare', true);
        return;
      }

      const link = document.createElement('a');
      link.href = lastImageUrl;
      link.download = `artemisia-${Date.now()}.png`;
      link.click();
      
      showStatus('üì• Download avviato');
    }

    function exportMultiple() {
      if (history.length === 0) {
        showStatus('‚ö†Ô∏è Nessuna immagine nella cronologia', true);
        return;
      }

      showStatus('üì§ Preparazione export multiplo...');
      
      // In una implementazione reale, creereste un ZIP
      history.slice(-5).forEach((item, index) => {
        const link = document.createElement('a');
        link.href = item.url;
        link.download = `artemisia-batch-${index + 1}.png`;
        setTimeout(() => link.click(), index * 500);
      });
      
      showStatus('üì§ Export multiplo avviato');
    }

    // ===== Upscaling =====
    async function upscale2x() {
      await upscaleImage(2);
    }

    async function upscale4x() {
      await upscaleImage(4);
    }

    async function upscaleImage(factor) {
      if (!lastImageUrl) {
        showStatus('‚ö†Ô∏è Nessuna immagine da ingrandire', true);
        return;
      }

      try {
        showStatus(`üîç Upscaling ${factor}x in corso...`);
        
        if (USE_MOCK) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          showStatus(`‚úÖ Upscaling ${factor}x completato`);
        } else {
          const response = await fetch(UPSCALE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              image_url: lastImageUrl,
              factor: factor
            })
          });

          const result = await response.json();
          if (result.error) throw new Error(result.error);
          
          displayResult(result.upscaled_url, {});
          showStatus(`‚úÖ Upscaling ${factor}x completato`);
        }
      } catch (error) {
        showStatus(`‚ùå Errore upscaling: ${error.message}`, true);
      }
    }

    // ===== Rating System =====
    function showRatingSystem() {
      document.getElementById('ratingSystem').style.display = 'flex';
      updateStars(0);
    }

    function rateImage(rating) {
      currentRating = rating;
      updateStars(rating);
      showStatus(`‚≠ê Immagine valutata: ${rating}/5 stelle`);
      
      // Salva rating nella cronologia
      if (history.length > 0) {
        history[history.length - 1].rating = rating;
        saveHistory();
      }
    }

    function updateStars(rating) {
      const stars = document.querySelectorAll('.star');
      stars.forEach((star, index) => {
        star.classList.toggle('active', index < rating);
      });
    }

    // ===== History Management =====
    function addToHistory(url, prompt, seed) {
      const item = {
        url,
        prompt,
        seed,
        timestamp: Date.now(),
        rating: 0
      };
      
      history.unshift(item);
      if (history.length > 20) history.pop(); // Mantieni solo le ultime 20
      
      saveHistory();
      renderHistory();
    }

    function saveHistory() {
      localStorage.setItem('artemisia-history', JSON.stringify(history));
    }

    function renderHistory() {
      const grid = document.getElementById('historyGrid');
      
      if (history.length === 0) {
        grid.innerHTML = '<div class="small" style="grid-column:1/-1;text-align:center;padding:20px">Nessuna generazione ancora</div>';
        return;
      }

      grid.innerHTML = history.map((item, index) => `
        <div class="card-thumb" onclick="loadFromHistory(${index})">
          <img src="${item.url}" alt="Cronologia ${index + 1}" />
          <div class="thumb-actions">
            <button class="thumb-btn" onclick="event.stopPropagation(); downloadHistoryItem(${index})">üì•</button>
            <button class="thumb-btn" onclick="event.stopPropagation(); removeFromHistory(${index})">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function loadFromHistory(index) {
      const item = history[index];
      document.getElementById('prompt').value = item.prompt;
      document.getElementById('seed').value = item.seed;
      displayResult(item.url, {});
      updateStars(item.rating || 0);
      updateCounter();
      showStatus('üìã Caricato dalla cronologia');
    }

    function downloadHistoryItem(index) {
      const item = history[index];
      const link = document.createElement('a');
      link.href = item.url;
      link.download = `artemisia-history-${index + 1}.png`;
      link.click();
    }

    function removeFromHistory(index) {
      if (confirm('Rimuovere questa immagine dalla cronologia?')) {
        history.splice(index, 1);
        saveHistory();
        renderHistory();
        showStatus('üóëÔ∏è Rimosso dalla cronologia');
      }
    }

    // ===== Help Modal =====
    function showHelp() {
      document.getElementById('helpModal').style.display = 'block';
    }

    function hideHelp() {
      document.getElementById('helpModal').style.display = 'none';
    }

    // ===== Initialization =====
    function init() {
      updateCounter();
      updateCreativity();
      updateQuality();
      updateRatio();
      renderHistory();
      
      // Carica ultimo tema
      const theme = localStorage.getItem('artemisia-theme') || 'dark';
      root.setAttribute('data-theme', theme);
    }

    // Avvia l'app
    document.addEventListener('DOMContentLoaded', init);

    // Chiudi modal con ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideHelp();
        if (document.getElementById('comparisonMode').style.display !== 'none') {
          toggleComparison();
        }
      }
    });
  </script>
</body>
</html>
