<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artemisia Story ¬∑ Generatore & Trasformatore di immagini AI</title>
  <link rel="icon" href="logo-artemisia.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-start:#0f172a; --bg-end:#1e1b4b; --card:#0b1020cc; --text:#e2e8f0; --muted:#94a3b8;
      --brand:#6366f1; --brand-2:#8b5cf6; --accent:#f8c045; --ring:rgba(99,102,241,.35);
      --ok:#34d399; --warn:#f59e0b; --err:#f87171; --surface:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.14); --chip:rgba(148,163,184,.12); --shadow:0 18px 60px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg-start:#e8eef8; --bg-end:#dfe4ff; --card:#ffffffee; --text:#0f172a; --muted:#475569;
      --surface:#f8fafc; --border:rgba(2,6,23,.12); --chip:rgba(2,6,23,.06); --shadow:0 18px 50px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background:
        radial-gradient(1000px 600px at -10% -10%, #0ea5e980, transparent 60%),
        radial-gradient(800px 500px at 110% 10%, #a78bfa66, transparent 60%),
        linear-gradient(135deg, var(--bg-start), var(--bg-end));
      overflow-x:hidden;
    }
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:22px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:48px;height:48px;border-radius:14px;display:grid;place-items:center;box-shadow:var(--shadow);background:var(--surface)}
    .logo img{width:100%;height:100%;object-fit:contain;display:block;border-radius:12px}
    .title{font-size:28px;font-weight:800;letter-spacing:.2px}
    .subtitle{font-size:14px;color:var(--muted)}
    .actions{display:flex;align-items:center;gap:8px}
    .icon-btn{border:1px solid var(--border);background:var(--surface);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;transition:all .2s ease}
    .icon-btn:hover{transform:translateY(-1px);border-color:var(--accent)}

    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:20px}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:22px}
    .section-title{display:flex;align-items:center;gap:8px;font-weight:700;margin-bottom:10px}
    .section-title .emoji{font-size:20px}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
    .chip{position:relative;padding:8px 12px;border:1px solid var(--border);background:var(--chip);border-radius:999px;font-size:12px;cursor:pointer;user-select:none;transition:all .2s ease}
    .chip.active{outline:2px solid var(--ring);border-color:transparent;background:rgba(99,102,241,.20)}
    .chip:hover{background:rgba(99,102,241,.12);border-color:var(--brand)}
    .chip.business{border-color:rgba(34,197,94,.28);background:rgba(34,197,94,.10)}
    .chip.business.active{background:rgba(34,197,94,.18);outline-color:rgba(34,197,94,.45)}
    .chip.creative{border-color:rgba(245,158,11,.28);background:rgba(245,158,11,.10)}
    .chip.creative.active{background:rgba(245,158,11,.18);outline-color:rgba(245,158,11,.45)}
    .chip.photo{border-color:rgba(59,130,246,.28);background:rgba(59,130,246,.10)}
    .chip.photo.active{background:rgba(59,130,246,.18);outline-color:rgba(59,130,246,.45)}
    .chip[data-preview]:hover::after{
      content:"Anteprima";
      position:absolute;bottom:100%;left:50%;transform:translateX(-50%);
      padding:4px 8px;font-size:11px;background:rgba(0,0,0,.7);color:#fff;border-radius:6px;white-space:nowrap;pointer-events:none;
    }

    .controls{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0}
    .select,.slider{display:flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--surface);padding:10px 12px;border-radius:12px}
    .select select, .select input{background:transparent;border:none;color:var(--text);font-size:14px}
    .select select:focus, .select input:focus{outline:none}
    .slider input{accent-color:var(--brand)}
    .slider span{font-size:12px;color:var(--muted);min-width:50px}

    .textarea{position:relative}
    textarea{width:100%;min-height:120px;resize:vertical;border:2px solid transparent;border-radius:16px;padding:16px 18px;background:var(--surface);color:var(--text);line-height:1.55;font-size:15px}
    textarea:focus{outline:none;box-shadow:0 0 0 4px var(--ring);border-color:transparent}
    textarea::placeholder{color:var(--muted);opacity:.85}
    .counter{position:absolute;right:12px;bottom:8px;font-size:12px;color:var(--muted)}

    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid var(--border);cursor:pointer;transition:transform .12s ease, box-shadow .2s ease;background:var(--surface);color:var(--text);text-decoration:none;font-weight:700;font-size:14px}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none!important}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent;color:#fff;box-shadow:0 10px 24px rgba(99,102,241,.45)}
    .btn.primary:not(:disabled):hover{transform:translateY(-2px);box-shadow:0 16px 36px rgba(99,102,241,.55)}
    .btn.outline:not(:disabled):hover{border-color:var(--accent);background:rgba(248,192,69,.10)}

    .status{margin-top:12px;padding:12px 16px;border-radius:12px;font-size:14px;font-weight:600;display:none;align-items:center;gap:10px}
    .status.ok{background:rgba(52,211,153,.10);color:var(--ok);border:1px solid rgba(52,211,153,.30)}
    .status.err{background:rgba(248,113,113,.10);color:var(--err);border:1px solid rgba(248,113,113,.30)}

    .frame{position:relative;background:linear-gradient(135deg,#0b1020,#1f2937);border:2px dashed var(--border);border-radius:18px;display:grid;place-items:center;overflow:hidden;transition:border-color .2s ease, box-shadow .2s ease}
    .frame.ratio-1-1{aspect-ratio:1/1}
    .frame.ratio-3-4{aspect-ratio:3/4}
    .frame.ratio-4-3{aspect-ratio:4/3}
    .frame.ratio-16-9{aspect-ratio:16/9}
    .frame.ratio-9-16{aspect-ratio:9/16}
    .frame.drag{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
    .frame img{max-width:100%;max-height:100%;display:none;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .frame img.show{display:block;animation:fadeIn .35s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:scale(.98)} to{opacity:1;transform:scale(1)}}
    .placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:#cbd5e1;opacity:.9;text-align:center;padding:28px}
    .spinner{width:54px;height:54px;border-radius:50%;border:4px solid #ffffff20;border-top-color:var(--brand);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .progress{position:absolute;left:0;bottom:0;height:4px;width:0;background:linear-gradient(90deg,var(--brand),var(--accent));transition:width .3s ease;border-radius:0 0 16px 16px}

    .history{margin-top:18px}
    .history-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .card-thumb{position:relative;background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;transition:transform .15s ease, border-color .2s ease}
    .card-thumb:hover{transform:translateY(-2px);border-color:var(--accent)}
    .card-thumb img{display:block;width:100%;height:140px;object-fit:cover;transition:transform .3s ease}
    .card-thumb:hover img{transform:scale(1.05)}
    .thumb-actions{display:flex;gap:6px;position:absolute;right:8px;bottom:8px;opacity:0;transition:opacity .2s ease}
    .card-thumb:hover .thumb-actions{opacity:1}
    .small{font-size:12px;color:var(--muted)}

    .comparison-mode{display:none;margin:20px 0}
    .comparison-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .compare-item{text-align:center}
    .compare-item img{width:100%;border-radius:12px;border:2px solid var(--border)}
    .compare-controls{margin-top:8px}

    .rating-system{display:flex;align-items:center;gap:8px;margin:8px 0;font-size:12px}
    .stars{display:flex;gap:4px}
    .star{cursor:pointer;transition:transform .15s ease;font-size:16px}
    .star:hover{transform:scale(1.2)}
    .star.active{color:var(--accent)}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;align-items:center;justify-content:center}
    .modal-content{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:24px;max-width:500px;margin:20px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--text)}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="logo"><img src="logo-artemisia.png" alt="Artemisia AI" /></div>
        <div>
          <div class="title">Artemisia-story</div>
          <div class="subtitle">Generatore & Trasformatore di immagini AI</div>
        </div>
      </div>
      <div class="actions">
        <button class="icon-btn" id="themeBtn" title="Tema">üåó</button>
        <button class="icon-btn" onclick="showHelp()" title="Guida">‚ùî</button>
      </div>
    </header>

    <main class="grid">
      <!-- Colonna sinistra -->
      <section class="card">
        <div class="section-title"><span class="emoji">‚ú®</span><span>Scrivi il tuo prompt</span></div>

        <!-- Preset con stile/negative (non scrivono direttamente nel textarea) -->
        <div class="chips" id="styleChips">
          <span class="chip" data-key="cartoon"
                data-style="modern 2D cartoon, clean cel shading, bold outlines, flat colors, playful composition"
                data-negative="realistic photo, 3D render, stadium, crowd, sports"
                data-preview="https://picsum.photos/seed/cartoon/180/120">Cartoon</span>

          <span class="chip" data-key="ghibli"
                data-style="whimsical anime film look, Studio Ghibli style, hand-painted backgrounds, soft pastel palette, gentle lighting"
                data-negative="photo, hyperrealism, 3D render, harsh contrast, sci-fi tech, stadium"
                data-preview="https://picsum.photos/seed/ghibli/180/120">Ghibli</span>

          <span class="chip" data-key="biblico"
                data-style="sacred renaissance painting, dramatic chiaroscuro, warm golden light, oil on canvas texture, classical composition"
                data-negative="sports, stadium, crowd cheering, football, signage, modern clothes"
                data-preview="https://picsum.photos/seed/biblico/180/120">Biblico</span>
        </div>

        <!-- Business / Arte / Fotografia (esempi) -->
        <div class="section-title" style="margin-top:10px"><span class="emoji">üéØ</span><span>Business & Marketing</span></div>
        <div class="chips">
          <span class="chip business" data-style="minimal corporate branding, clean layout, strong typographic hierarchy"
                data-negative="busy background, clutter, gradients">Logo Business</span>
          <span class="chip business" data-style="product hero shot, studio softbox lighting, seamless background"
                data-negative="busy background, reflections, watermark">Prodotto</span>
          <span class="chip business" data-style="social media graphic, vibrant colors, bold composition, high contrast"
                data-negative="photo watermark, logo noise">Social Post</span>
        </div>

        <div class="section-title" style="margin-top:10px"><span class="emoji">üé®</span><span>Arte & Creativit√†</span></div>
        <div class="chips">
          <span class="chip creative" data-style="epic fantasy concept art, cinematic lighting, volumetric fog"
                data-negative="sci-fi tech, modern signage">Fantasy Art</span>
          <span class="chip creative" data-style="children book illustration, soft rounded shapes, pastel colors"
                data-negative="harsh contrast, photo realism">Per Bambini</span>
          <span class="chip creative" data-style="modern abstract art, geometric shapes, gradient fields, dynamic composition"
                data-negative="figurative realism, text">Arte Astratta</span>
        </div>

        <div class="section-title" style="margin-top:10px"><span class="emoji">üì∏</span><span>Fotografia</span></div>
        <div class="chips">
          <span class="chip photo" data-style="portrait 85mm, soft cinematic lighting, natural bokeh, high resolution"
                data-negative="overexposed, harsh shadows, watermark">Ritratto Pro</span>
          <span class="chip photo" data-style="landscape golden hour, saturated colors, panoramic composition"
                data-negative="haze, washed out, watermark">Paesaggio</span>
        </div>

        <!-- Parametri -->
        <div class="section-title" style="margin-top:14px"><span class="emoji">‚öôÔ∏è</span><span>Parametri</span></div>
        <div class="controls">
          <div class="slider">
            <label>Creativit√†:</label>
            <input type="range" id="creativity" min="0" max="100" value="70" oninput="updateCreativity()" />
            <span id="creativityValue">70</span>
          </div>
          <div class="slider">
            <label>Qualit√†:</label>
            <input type="range" id="quality" min="1" max="4" value="2" oninput="updateQuality()" />
            <span id="qualityValue">Standard</span>
          </div>
          <div class="select">
            <select id="variants">
              <option value="1">1 Variante</option>
              <option value="2">2 Varianti</option>
              <option value="4">4 Varianti</option>
            </select>
          </div>
          <div class="select">
            <select id="ratio" onchange="updateRatio()">
              <option value="1-1">1:1 (Quadrato)</option>
              <option value="3-4">3:4 (Ritratto)</option>
              <option value="9-16">9:16 (Verticale)</option>
              <option value="4-3">4:3 (Orizzontale)</option>
              <option value="16-9">16:9 (Wide)</option>
            </select>
          </div>
        </div>

        <!-- Prompt -->
        <div class="textarea">
          <textarea id="prompt" placeholder="Es.: Un angelo al tramonto su una collina, atmosfera serena, composizione armoniosa."></textarea>
          <div class="counter" id="counter">0/500</div>
        </div>

        <!-- Seed & azioni -->
        <div class="controls">
          <div class="select" style="gap:6px">
            <label>Seed:</label>
            <input type="number" id="seed" value="" placeholder="casuale" style="width:110px">
            <button class="btn outline" onclick="lockSeed()">üîí Blocca</button>
            <button class="btn outline" onclick="regenSimilar()">‚ôªÔ∏è Rigenera simile</button>
          </div>
        </div>

        <!-- Batch & confronto -->
        <div class="controls">
          <div class="select">
            <select id="batchSize">
              <option value="1">Genera 1</option>
              <option value="2">Genera 2</option>
              <option value="4">Genera 4</option>
            </select>
          </div>
          <button class="btn outline" onclick="generateBatch()">Batch Generate</button>
          <button class="btn outline" onclick="toggleComparison()" id="compareBtn" disabled>Confronta A/B</button>
        </div>

        <!-- Pulsanti principali -->
        <div class="btns">
          <button class="btn primary" onclick="generate()" id="generateBtn">üé® Genera</button>
          <button class="btn outline" onclick="surprise()">üé≤ Ispirami</button>
          <button class="btn outline" onclick="download()" id="downloadBtn" disabled>üì• Scarica PNG</button>
          <button class="btn outline" onclick="exportMultiple()" id="exportBtn" disabled>üì§ Export Multi</button>
          <button class="btn outline" onclick="upscale2x()" id="up2xBtn" disabled>üîç Upscale 2√ó</button>
          <button class="btn outline" onclick="upscale4x()" id="up4xBtn" disabled>üîé Upscale 4√ó</button>
        </div>

        <!-- Rating -->
        <div class="rating-system" id="ratingSystem" style="display:none;">
          <span>Valuta risultato:</span>
          <div class="stars" id="starRating">
            <span class="star" onclick="rateImage(1)">‚≠ê</span>
            <span class="star" onclick="rateImage(2)">‚≠ê</span>
            <span class="star" onclick="rateImage(3)">‚≠ê</span>
            <span class="star" onclick="rateImage(4)">‚≠ê</span>
            <span class="star" onclick="rateImage(5)">‚≠ê</span>
          </div>
        </div>

        <div id="status" class="status"></div>
      </section>

      <!-- Colonna destra -->
      <section class="card">
        <div class="section-title"><span class="emoji">üñºÔ∏è</span><span>Anteprima</span></div>
        <div class="frame ratio-1-1" id="frame" title="Trascina qui un'immagine (opzionale)">
          <img id="resultImg" alt="Risultato" />
          <div class="placeholder" id="placeholder">
            <div class="spinner" id="spinner" style="display:none"></div>
            <div class="ph-content">
              <div style="font-weight:800;opacity:.95;font-size:18px">Nessuna immagine ancora</div>
              <div class="small">Scrivi un prompt e premi "Genera"</div>
            </div>
          </div>
          <div class="progress" id="progress"></div>
        </div>

        <!-- Confronto A/B -->
        <div class="comparison-mode" id="comparisonMode">
          <div class="section-title"><span class="emoji">‚öñÔ∏è</span><span>Confronto Risultati</span></div>
          <div class="comparison-grid">
            <div class="compare-item">
              <img id="compareImg1" alt="A" />
              <div class="compare-controls">
                <button class="btn outline" onclick="selectWinner(1)">Preferisci A</button>
              </div>
            </div>
            <div class="compare-item">
              <img id="compareImg2" alt="B" />
              <div class="compare-controls">
                <button class="btn outline" onclick="selectWinner(2)">Preferisci B</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Cronologia -->
        <div class="history">
          <div class="section-title"><span class="emoji">üïò</span><span>Cronologia</span></div>
          <div class="history-grid" id="historyGrid">
            <div class="small" style="grid-column:1/-1;text-align:center;padding:20px">Nessuna generazione ancora</div>
          </div>
        </div>

        <div class="tips" style="margin-top:16px;padding:18px;border-left:3px solid var(--brand);background:linear-gradient(0deg,transparent,rgba(99,102,241,.10));border-radius:12px">
          <strong>üí° Suggerimenti rapidi</strong>
          <ul style="margin:.5rem 0 0 1.2rem; line-height:1.7; font-size:14px">
            <li>Usa i preset con **style/negative** per risultati coerenti</li>
            <li>Blocca un **seed** per esplorazioni consistenti</li>
            <li>Batch + Confronto A/B per scegliere il migliore</li>
            <li>Export in **PNG/JPG/WebP** in un click</li>
          </ul>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal per aiuto -->
  <div id="helpModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üöÄ Guida Artemisia Story</h3>
        <button class="close" onclick="closeHelp()">&times;</button>
      </div>
      <div>
        <h4>Come usare:</h4>
        <ul>
          <li><strong>Preset:</strong> Clicca sui chip per applicare stili predefiniti</li>
          <li><strong>Prompt:</strong> Descrivi cosa vuoi generare in italiano</li>
          <li><strong>Seed:</strong> Blocca un numero per risultati consistenti</li>
          <li><strong>Batch:</strong> Genera pi√π varianti e confrontale</li>
          <li><strong>Drag & Drop:</strong> Trascina un'immagine per modificarla</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Hidden file input per drag&drop/click -->
  <input id="fileInput" type="file" accept="image/*" onchange="handleFile(this)" style="display:none" />
  
  <!-- Tooltip preview per chip -->
  <div id="tooltip" class="tooltip" aria-hidden="true" style="position:fixed;z-index:50;display:none;border:1px solid var(--border);background:var(--card);border-radius:12px;box-shadow:var(--shadow);overflow:hidden">
    <img alt="preview" style="display:block;width:180px;height:120px;object-fit:cover">
    <div class="hint" style="padding:8px 10px;font-size:12px;color:var(--muted);max-width:240px"></div>
  </div>

  <script>
    // ===== CONFIG =====
    const USE_MOCK = true; // imposta a false per usare gli endpoint reali
    const BASE = (location.hostname==='localhost' || location.hostname==='127.0.0.1' || location.protocol==='file:') ? 'http://localhost:3000' : '';
    const GEN_URL = `${BASE}/api/generate`;
    const EDIT_URL = `${BASE}/api/edit`;
    const UPSCALE_URL = `${BASE}/api/upscale`;

    // ===== STATE =====
    let lastImageUrl = null;
    let lastFile = null;
    let lockedSeed = null;
    let batchInProgress = false;
    let comparisonImages = [];
    const history = [];
    let currentRating = 0;

    // ===== THEME =====
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('artemisia-theme');
    if(savedTheme) root.setAttribute('data-theme', savedTheme);
    
    document.getElementById('themeBtn').onclick = () => {
      const currentTheme = root.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', newTheme);
      localStorage.setItem('artemisia-theme', newTheme);
    };

    // ===== TOOLTIP SYSTEM =====
    const tooltip = document.getElementById('tooltip');
    function positionTooltip(e) {
      tooltip.style.left = (e.clientX + 14) + 'px';
      tooltip.style.top = (e.clientY + 14) + 'px';
    }

    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => chip.classList.toggle('active'));
      
      chip.addEventListener('mouseenter', e => {
        const src = chip.dataset.preview;
        if (!src) return;
        
        tooltip.querySelector('img').src = src;
        tooltip.querySelector('.hint').textContent = chip.dataset.style || chip.textContent;
        tooltip.style.display = 'block';
        positionTooltip(e);
      });
      
      chip.addEventListener('mousemove', positionTooltip);
      chip.addEventListener('mouseleave', () => {
        tooltip.style.display = 'none';
      });
    });

    // ===== UTILITY FUNCTIONS =====
    function showStatus(message, isError = false) {
      const status = document.getElementById('status');
      status.style.display = 'flex';
      status.className = `status ${isError ? 'err' : 'ok'}`;
      status.innerHTML = message;
      
      if (!isError) {
        setTimeout(hideStatus, 3000);
      }
    }

    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }

    function updateCounter() {
      const prompt = document.getElementById('prompt');
      const counter = document.getElementById('counter');
      const length = prompt.value.length;
      
      counter.textContent = `${length}/500`;
      if (length > 500) {
        counter.style.color = 'var(--err)';
      } else if (length > 400) {
        counter.style.color = 'var(--warn)';
      } else {
        counter.style.color = 'var(--muted)';
      }
    }

    function updateCreativity() {
      const slider = document.getElementById('creativity');
      const display = document.getElementById('creativityValue');
      display.textContent = slider.value;
    }

    function updateQuality() {
      const slider = document.getElementById('quality');
      const display = document.getElementById('qualityValue');
      const qualityNames = ['', 'Base', 'Standard', 'Alta', 'Ultra'];
      display.textContent = qualityNames[slider
