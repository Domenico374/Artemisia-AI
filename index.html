<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artemisia Story ‚Äì Generatore & Trasformatore AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-start:#0f172a; --bg-end:#1e1b4b; --card:#0b1020cc; --text:#e2e8f0; --muted:#94a3b8;
      --brand:#6366f1; --brand-2:#8b5cf6; --accent:#f8c045; --ring:rgba(99,102,241,.35);
      --ok:#34d399; --err:#f87171; --surface:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.14); --chip:rgba(148,163,184,.12); --shadow:0 18px 60px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg-start:#e8eef8; --bg-end:#dfe4ff; --card:#ffffffee; --text:#0f172a; --muted:#475569;
      --surface:#f8fafc; --border:rgba(2,6,23,.12); --chip:rgba(2,6,23,.06); --shadow:0 18px 50px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background:linear-gradient(135deg,var(--bg-start),var(--bg-end));
    }
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:12px;overflow:hidden;background:var(--surface);display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo img{width:100%;height:100%;object-fit:contain}
    .title{font-size:22px;font-weight:800}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
    .chip{padding:7px 12px;border:1px solid var(--border);background:var(--chip);border-radius:999px;font-size:12px;cursor:pointer}
    .chip.active{outline:2px solid var(--ring);background:rgba(99,102,241,.18)}
    .textarea textarea{width:100%;min-height:120px;border-radius:12px;padding:12px;border:1px solid var(--border);background:var(--surface);color:var(--text)}
    .counter{font-size:12px;color:var(--muted);text-align:right;margin-top:6px}
    .controls{margin:10px 0;color:var(--muted);font-size:14px}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border:none;color:#fff}
    .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .frame{aspect-ratio:1/1;border:2px solid var(--border);border-radius:14px;background:var(--surface);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .frame img{max-width:100%;max-height:100%;display:none}
    .status{margin-top:10px;padding:10px;border-radius:10px;display:none;font-weight:600}
    .status.ok{background:rgba(52,211,153,.1);color:var(--ok)}
    .status.err{background:rgba(248,113,113,.1);color:var(--err)}
    .history-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:10px}
    .card-thumb{position:relative;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .card-thumb img{width:100%;height:100px;object-fit:cover}
    .thumb-actions{position:absolute;right:6px;bottom:6px;display:flex;gap:6px}
    .star{cursor:pointer;font-size:18px}
    .star.active{color:var(--accent)}
  </style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo"><img src="logo-artemisia.png" alt="logo"></div>
      <div>
        <div class="title">Artemisia Story</div>
        <div style="font-size:13px;color:var(--muted)">Generatore & Trasformatore AI</div>
      </div>
    </div>
    <div>
      <button class="btn" onclick="toggleTheme()">üåó</button>
    </div>
  </header>

  <main class="grid">
    <!-- Colonna sinistra -->
    <section class="card">
      <div><strong>‚ú® Prompt</strong></div>
      <div class="chips">
        <span class="chip" data-style="modern 2D cartoon, clean cel shading, bold outlines, flat colors"
              data-negative="realistic details, photo, 3D render, stadium, crowd, sports">Cartoon</span>
        <span class="chip" data-style="whimsical anime film look, Studio Ghibli style, soft pastel palette, hand-painted backgrounds"
              data-negative="photo, hyperrealism, 3D render, sci-fi tech, stadium">Ghibli</span>
        <span class="chip" data-style="sacred renaissance painting, dramatic chiaroscuro, warm golden light, oil on canvas texture"
              data-negative="sports, stadium, crowd, modern clothes, signage">Biblico</span>
      </div>

      <div class="textarea">
        <textarea id="prompt" placeholder="Descrivi la scena... (es. un angelo al tramonto su una collina)"></textarea>
        <div class="counter" id="counter">0/500</div>
      </div>

      <div class="controls">
        Creativit√†
        <input type="range" id="creativity" min="0" max="100" value="70" oninput="updateCreativity()">
        <span id="creativityValue">70</span>
        &nbsp;&nbsp;‚Ä¢&nbsp;&nbsp;
        Qualit√†
        <input type="range" id="quality" min="1" max="4" value="2" oninput="updateQuality()">
        <span id="qualityValue">Standard</span>
      </div>

      <div class="controls">
        Seed
        <input type="number" id="seed" placeholder="casuale" style="width:110px">
        <button class="btn" onclick="lockSeed()">üîí Blocca</button>
        <button class="btn" onclick="regenSimilar()">‚ôªÔ∏è Simile</button>
      </div>

      <div class="btns">
        <button class="btn primary" onclick="generate()" id="generateBtn">üé® Genera</button>
        <button class="btn" onclick="upscale()">üîç Upscale 2√ó</button>
        <button class="btn" onclick="exportMultiple()">üì§ Export</button>
      </div>

      <div class="status" id="status"></div>
    </section>

    <!-- Colonna destra -->
    <section class="card">
      <div><strong>üñºÔ∏è Anteprima</strong></div>
      <div class="frame">
        <img id="resultImg" alt="Risultato">
        <div id="placeholder" style="color:var(--muted)">Nessuna immagine</div>
      </div>

      <div id="ratingSystem" style="margin-top:10px;display:none">
        Valuta:
        <span class="star" onclick="rateImage(1)">‚≠ê</span>
        <span class="star" onclick="rateImage(2)">‚≠ê</span>
        <span class="star" onclick="rateImage(3)">‚≠ê</span>
        <span class="star" onclick="rateImage(4)">‚≠ê</span>
        <span class="star" onclick="rateImage(5)">‚≠ê</span>
      </div>

      <div style="margin-top:20px"><strong>üïò Cronologia</strong></div>
      <div class="history-grid" id="historyGrid"></div>
    </section>
  </main>
</div>

<script>
  // ========= Endpoints =========
  const BASE = ""; // lascia vuoto su Vercel se gli endpoint sono sullo stesso dominio
  const GEN_URL = `${BASE}/api/generate`;
  const UPSCALE_URL = `${BASE}/api/upscale`;

  // ========= Stato =========
  let lastImageUrl = null;
  let lockedSeed = null;
  const history = [];

  // ========= Prompt builder =========
  function buildPrompt(){
    const base = document.getElementById('prompt').value.trim();
    const chips = [...document.querySelectorAll('.chip.active')];
    const styles = chips.map(c => c.dataset.style).filter(Boolean).join('; ');
    return styles ? `${base}. Style: ${styles}` : base;
  }
  function buildNegative(){
    const NEG_BASE = "text watermark, logo, signature, blurry, low-res, jpeg artifacts, extra fingers, mutated hands";
    const chips = [...document.querySelectorAll('.chip.active')];
    const neg = chips.map(c => c.dataset.negative).filter(Boolean).join(', ');
    return neg ? `${NEG_BASE}, ${neg}` : NEG_BASE;
  }

  // ========= Chips =========
  document.querySelectorAll('.chip').forEach(c => {
    c.addEventListener('click', () => c.classList.toggle('active'));
  });

  // ========= Counter fix =========
  const promptEl = document.getElementById('prompt');
  promptEl.addEventListener('input', () => {
    const len = promptEl.value.length;
    document.getElementById('counter').textContent = `${len}/500`;
  });

  // ========= Theme =========
  function toggleTheme(){
    const root = document.documentElement;
    root.setAttribute('data-theme', root.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
  }

  // ========= Status UI =========
  function showStatus(msg, err=false){
    const s = document.getElementById('status');
    s.style.display = 'block';
    s.textContent = msg;
    s.className = `status ${err ? 'err' : 'ok'}`;
  }

  // ========= Seed =========
  function lockSeed(){
    lockedSeed = document.getElementById('seed').value || Math.floor(Math.random()*1e6);
    document.getElementById('seed').value = lockedSeed;
    showStatus(`üîí Seed bloccato: ${lockedSeed}`);
  }
  function regenSimilar(){
    if(!lockedSeed){ showStatus('Blocca prima un seed', true); return; }
    lockedSeed = parseInt(lockedSeed) + Math.floor(Math.random()*10 + 1);
    document.getElementById('seed').value = lockedSeed;
    showStatus(`‚ôªÔ∏è Variazione seed: ${lockedSeed}`);
  }

  // ========= Helpers UI =========
  function updateCreativity(){ document.getElementById('creativityValue').textContent = document.getElementById('creativity').value; }
  function updateQuality(){
    const v = +document.getElementById('quality').value;
    const lbl = ['Bassa','Standard','Alta','Ultra'];
    document.getElementById('qualityValue').textContent = lbl[v-1];
  }

  // ========= Generazione =========
  async function generate(){
    const prompt = buildPrompt();
    if(!prompt || prompt.length < 3){ showStatus('‚ùå Inserisci un prompt pi√π dettagliato', true); return; }

    const payload = {
      prompt,
      negative_prompt: buildNegative(),
      seed: lockedSeed || undefined,
      creativity: +document.getElementById('creativity').value,
      quality: +document.getElementById('quality').value,
      variants: 1
    };

    showStatus('‚ú® Generazione...');
    try{
      const res = await fetch(GEN_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || 'Errore server');

      lastImageUrl = data.image_url;
      const img = document.getElementById('resultImg');
      img.src = lastImageUrl;
      img.style.display = 'block';
      document.getElementById('placeholder').style.display = 'none';

      addHistory(lastImageUrl, prompt);
      document.getElementById('ratingSystem').style.display = 'block';
      showStatus('‚úÖ Immagine generata');
    }catch(e){
      showStatus('‚ùå ' + e.message, true);
    }
  }

  // ========= Upscale =========
  async function upscale(){
    if(!lastImageUrl){ showStatus('Nessuna immagine', true); return; }
    showStatus('üîç Upscale 2√ó...');
    try{
      const res = await fetch(UPSCALE_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ image_url: lastImageUrl, scale: 2 })
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || 'Errore upscale');
      lastImageUrl = data.image_url;
      document.getElementById('resultImg').src = lastImageUrl;
      showStatus('‚úÖ Upscale completato');
    }catch(e){
      showStatus('‚ùå ' + e.message, true);
    }
  }

  // ========= Cronologia =========
  function addHistory(src, caption){
    history.unshift({src, caption, rating:0});
    renderHistory();
  }
  function renderHistory(){
    const g = document.getElementById('historyGrid');
    g.innerHTML = history.map((h,i)=>`
      <div class="card-thumb">
        <img src="${h.src}" alt="h${i}">
        <div class="thumb-actions">
          <button class="btn" onclick="reusePrompt(${i})">‚ôªÔ∏è</button>
          <button class="btn" onclick="downloadFromSrc('${h.src.replace(/'/g,"\\'")}')">‚¨áÔ∏è</button>
        </div>
      </div>
    `).join('');
  }
  function reusePrompt(i){
    if(!history[i]) return;
    document.getElementById('prompt').value = history[i].caption;
    const len = history[i].caption.length;
    document.getElementById('counter').textContent = `${len}/500`;
    showStatus('üìù Prompt riutilizzato');
  }

  // ========= Rating =========
  function rateImage(r){
    document.querySelectorAll('.star').forEach((s,i)=>s.classList.toggle('active', i<r));
    if(history[0]) history[0].rating = r;
    showStatus(`‚≠ê ${r}/5`);
  }

  // ========= Export =========
  function exportMultiple(){
    if(!lastImageUrl){ showStatus('Nessuna immagine', true); return; }
    ['png','jpg','webp'].forEach(fmt => downloadAsFormat(lastImageUrl, fmt));
    showStatus('üì§ Export multiplo avviato');
  }
  function downloadAsFormat(url, fmt){
    const a = document.createElement('a');
    a.href = url; a.download = `artemisia-ai.${fmt}`; a.click();
  }
  function downloadFromSrc(src){
    const a = document.createElement('a');
    a.href = src; a.download = 'artemisia-ai.png'; a.click();
  }

  // ========= Shortcut =========
  document.addEventListener('keydown', e => {
    if((e.ctrlKey||e.metaKey) && e.key === 'Enter'){ generate(); }
  });
</script>
</body>
</html>
