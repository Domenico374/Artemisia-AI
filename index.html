<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artemisia Story — Laboratorio di Creatività Digitale</title>
  <meta name="description" content="Generatore e trasformazione di immagini e storie con AI. Artemisia Story unisce arte e intelligenza artificiale con un'interfaccia semplice e potente." />
  <meta property="og:title" content="Artemisia Story" />
  <meta property="og:description" content="Genera immagini e storie con AI: prompt, stili, qualità, formati." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://artemisia-story.vercel.app" />
  <link rel="icon" href="/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--brand:#6f54ff;--ink:#0f172a;--bg:#f8f7ff}
    body{background:linear-gradient(180deg,#f5f3ff, #f8f7ff)}
    .card{border-radius:1.25rem; box-shadow:0 8px 30px rgba(0,0,0,.08)}
    .pill{border-radius:999px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body class="text-slate-900">
  <!-- Header -->
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-2">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 grid place-items-center rounded-2xl bg-violet-600 text-white font-bold">A</div>
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Artemisia Story</h1>
        <p class="text-sm text-slate-600 -mt-1">Laboratorio di Creatività Digitale — genera <span class="font-medium">immagini</span> e <span class="font-medium">storie</span> dall'AI</p>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 pb-16 grid md:grid-cols-2 gap-6">
    <!-- Controls -->
    <section class="card bg-white p-5 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Scrivi il tuo prompt</h2>
        <div class="inline-flex p-1 bg-slate-100 pill">
          <button id="mode-image" class="px-3 py-1 text-sm pill bg-white shadow border border-slate-200">Immagine</button>
          <button id="mode-story" class="px-3 py-1 text-sm pill">Storia</button>
        </div>
      </div>

      <textarea id="prompt" rows="6" placeholder="Esempio: Vendemmia tradizionale al tramonto, stile acquerello caldo, atmosfera di festa…" class="w-full resize-y rounded-xl border border-slate-200 p-3 focus:outline-none focus:ring-2 focus:ring-violet-400"></textarea>

      <!-- Tags quick pick -->
      <div class="mt-3 flex flex-wrap gap-2 text-sm">
        <span class="px-3 py-1 bg-slate-100 pill cursor-pointer quick" data-add="Cartoon">Cartoon</span>
        <span class="px-3 py-1 bg-slate-100 pill cursor-pointer quick" data-add="Fotorealistico">Fotorealistico</span>
        <span class="px-3 py-1 bg-slate-100 pill cursor-pointer quick" data-add="Acquerello">Acquerello</span>
        <span class="px-3 py-1 bg-slate-100 pill cursor-pointer quick" data-add="Ghibli">Stile Ghibli</span>
        <span class="px-3 py-1 bg-slate-100 pill cursor-pointer quick" data-add="Vintage 90">Vintage 90</span>
      </div>

      <!-- Advanced params -->
      <div class="grid sm:grid-cols-3 gap-3 mt-5">
        <div>
          <label class="block text-sm mb-1">Stile</label>
          <select id="style" class="w-full rounded-lg border border-slate-200 p-2">
            <option value="">Automatico</option>
            <option>Cartoon</option>
            <option>Fotorealistico</option>
            <option>Acquerello</option>
            <option>Stile Ghibli</option>
            <option>Vintage</option>
            <option>Arte Digitale</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Qualità</label>
          <select id="quality" class="w-full rounded-lg border border-slate-200 p-2">
            <option>Standard</option>
            <option>Alta</option>
            <option>Bozza</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Formato</label>
          <select id="format" class="w-full rounded-lg border border-slate-200 p-2">
            <option value="1:1">Quadrato (1:1)</option>
            <option value="16:9">Orizzontale (16:9)</option>
            <option value="9:16">Verticale (9:16)</option>
            <option value="4:5">Ritratto (4:5)</option>
          </select>
        </div>
      </div>

      <!-- Actions -->
      <div class="mt-5 flex flex-wrap items-center gap-3">
        <button id="btn-generate" class="px-5 py-2.5 rounded-xl bg-violet-600 text-white font-medium hover:bg-violet-700">Genera</button>
        <button id="btn-clear" class="px-4 py-2 rounded-xl border border-slate-200">Cancella</button>
        <span id="status" class="text-sm text-slate-500"></span>
      </div>

      <!-- Debug (collapsible) -->
      <details class="mt-4">
        <summary class="cursor-pointer text-sm text-slate-600">Dettagli richiesta (debug)</summary>
        <pre id="debug" class="mono text-xs bg-slate-50 rounded-lg p-3 overflow-auto"></pre>
      </details>
    </section>

    <!-- Preview / Output -->
    <section class="card bg-white p-5 md:p-6">
      <h2 class="text-lg font-semibold mb-3">Anteprima</h2>
      <div id="preview" class="aspect-square md:aspect-[4/3] w-full bg-slate-50 rounded-xl grid place-items-center overflow-hidden">
        <div class="text-slate-400 text-sm">Il risultato apparirà qui</div>
      </div>
      <div class="mt-4 flex gap-3">
        <button id="btn-download" class="px-4 py-2 rounded-xl border border-slate-200 disabled:opacity-50" disabled>Scarica PNG</button>
        <button id="btn-copy" class="px-4 py-2 rounded-xl border border-slate-200 disabled:opacity-50" disabled>Copia testo</button>
      </div>

      <h3 class="mt-6 mb-2 font-medium">Cronologia</h3>
      <div id="history" class="grid grid-cols-4 gap-2"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="max-w-6xl mx-auto px-4 pb-10 text-xs text-slate-500">
    <div>© <span id="year"></span> Artemisia Story · dove l'arte incontra l'AI</div>
  </footer>

  <script>
    const els = {
      modeImage: document.getElementById('mode-image'),
      modeStory: document.getElementById('mode-story'),
      prompt: document.getElementById('prompt'),
      style: document.getElementById('style'),
      quality: document.getElementById('quality'),
      format: document.getElementById('format'),
      btnGenerate: document.getElementById('btn-generate'),
      btnClear: document.getElementById('btn-clear'),
      btnDownload: document.getElementById('btn-download'),
      btnCopy: document.getElementById('btn-copy'),
      status: document.getElementById('status'),
      preview: document.getElementById('preview'),
      history: document.getElementById('history'),
      debug: document.getElementById('debug'),
    };

    let mode = 'image'; // 'image' | 'story'
    const API_ENDPOINT = '/api/generate'; // <— Assicurati che esista nel progetto

    // UI helpers
    function setMode(newMode){
      mode = newMode;
      els.modeImage.classList.toggle('bg-white', mode==='image');
      els.modeImage.classList.toggle('shadow', mode==='image');
      els.modeImage.classList.toggle('border', mode==='image');
      els.modeStory.classList.toggle('bg-white', mode==='story');
      els.modeStory.classList.toggle('shadow', mode==='story');
      els.modeStory.classList.toggle('border', mode==='story');
      els.btnCopy.disabled = (mode !== 'story');
    }

    els.modeImage.addEventListener('click', ()=>setMode('image'));
    els.modeStory.addEventListener('click', ()=>setMode('story'));

    // Quick tags → append to prompt
    document.querySelectorAll('.quick').forEach(chip=>{
      chip.addEventListener('click',()=>{
        const add = chip.dataset.add;
        const cur = els.prompt.value.trim();
        els.prompt.value = cur ? cur + ', ' + add : add;
      })
    })

    // Download helper
    function downloadURI(uri, name) {
      const a = document.createElement('a');
      a.download = name; a.href = uri; document.body.appendChild(a); a.click(); a.remove();
    }

    // Render helpers
    function renderImage(src){
      els.preview.innerHTML = '';
      const img = document.createElement('img');
      img.src = src; img.alt = 'Generazione'; img.className = 'w-full h-full object-cover';
      els.preview.appendChild(img);
      els.btnDownload.disabled = false;
      els.btnCopy.disabled = true;
      els.btnDownload.onclick = () => downloadURI(src, 'artemisia-story.png');
      // push to history
      const thumb = img.cloneNode();
      thumb.className = 'w-full h-24 object-cover rounded-lg';
      els.history.prepend(thumb);
    }

    function renderText(text){
      els.preview.innerHTML = '';
      const box = document.createElement('div');
      box.className = 'p-4 text-sm max-h-full overflow-auto';
      box.textContent = text;
      els.preview.appendChild(box);
      els.btnCopy.disabled = false;
      els.btnDownload.disabled = true;
      els.btnCopy.onclick = async () => {
        try { await navigator.clipboard.writeText(text); els.status.textContent = 'Testo copiato'; } catch(e){ console.warn(e); }
      };
      // history item
      const cap = document.createElement('div');
      cap.className = 'text-[10px] bg-slate-100 rounded p-1 line-clamp-3';
      cap.textContent = text;
      els.history.prepend(cap);
    }

    function combinePrompt(){
      const base = els.prompt.value.trim();
      const style = els.style.value.trim();
      const format = els.format.value;
      const quality = els.quality.value;
      // Uniamo come nel vecchio Artemisia AI
      const parts = [base];
      if(style) parts.push('stile: ' + style);
      parts.push('qualità: ' + quality);
      parts.push('formato: ' + format);
      return parts.filter(Boolean).join(', ');
    }

    async function generate(){
      const userPrompt = els.prompt.value.trim();
      if(!userPrompt){
        els.status.textContent = 'Scrivi una descrizione prima di generare.';
        return;
      }
      els.status.textContent = 'Genero…';
      els.btnGenerate.disabled = true;

      const payload = {
        type: mode,               // 'image' | 'story'
        prompt: combinePrompt(),  // testo completo
        rawPrompt: userPrompt,    // comodo per il backend
        style: els.style.value || null,
        quality: els.quality.value,
        format: els.format.value
      };

      els.debug.textContent = JSON.stringify({ endpoint: API_ENDPOINT, payload }, null, 2);

      try{
        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const t = await res.text();
          throw new Error('HTTP ' + res.status + ' — ' + t);
        }
        const json = await res.json();
        // Possibili forme di risposta supportate
        if(json.imageUrl){
          renderImage(json.imageUrl);
        } else if(json.imageB64){
          renderImage('data:image/png;base64,' + json.imageB64);
        } else if(Array.isArray(json.images) && json.images.length){
          const src = json.images[0].url || json.images[0];
          renderImage(src);
        } else if(json.text){
          renderText(json.text);
        } else if(json.story){
          renderText(json.story);
        } else {
          renderText('Risposta ricevuta ma non riconosciuta: ' + JSON.stringify(json));
        }
        els.status.textContent = 'Pronto';
      } catch(err){
        console.error(err);
        els.status.textContent = 'Errore: ' + err.message;
        renderText('Errore: ' + err.message);
      } finally {
        els.btnGenerate.disabled = false;
      }
    }

    els.btnGenerate.addEventListener('click', generate);
    els.btnClear.addEventListener('click', ()=>{
      els.prompt.value = '';
      els.preview.innerHTML = '<div class="text-slate-400 text-sm">Il risultato apparirà qui</div>';
      els.status.textContent = '';
      els.debug.textContent = '';
      els.btnDownload.disabled = true;
      els.btnCopy.disabled = true;
    });

    // init
    setMode('image');
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
