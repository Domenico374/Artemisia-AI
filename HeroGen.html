<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HeroGen ‚Äî Generatore & Trasformatore di immagini</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --brand:#0d3b4f; --ink:#0f172a; --muted:#475569; --page:#f4f7fb; --ok:#0e9f6e; --err:#ef4444;
           --card:#fff; --ring:#93c5fd; --shadow:0 8px 24px rgba(2,6,23,.08); }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--page);color:var(--ink)}
    .wrap{max-width:1200px;margin:40px auto;padding:0 16px}
    h1{display:flex;align-items:center;gap:10px;margin:0 0 14px}
    h1 small{font-weight:600;color:var(--muted);font-size:.9rem}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);border:1px solid #e5e7eb}
    .pad{padding:18px}
    textarea{width:100%;min-height:120px;padding:12px;border-radius:12px;border:1px solid #cbd5e1;font:inherit}
    textarea:focus{outline:none;box-shadow:0 0 0 3px var(--ring)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#0b1b2a}
    .btn.ghost{background:#fff;color:var(--brand);border:1px solid #cbd5e1}
    .status{margin-top:12px;padding:10px 12px;border-radius:10px;font-size:.95rem}
    .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .err{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .muted{color:var(--muted);font-size:.92rem}
    .viewer{margin-top:16px}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .imgBox{display:grid;place-items:center;background:#0b1b2a;border-radius:12px;min-height:720px;padding:10px;border:1px solid #233041}
    .imgBox img{width:100%;height:auto;max-height:100%;object-fit:contain;border-radius:10px;display:block}
    .chip{border:1px dashed #cbd5e1;border-radius:10px;padding:6px 10px;background:#fff}
    .spin{width:16px;height:16px;border:3px solid #93c5fd;border-top-color:transparent;border-radius:50%;display:inline-block;animation:rot 1s linear infinite;margin-right:8px}
    @keyframes rot{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üõ°Ô∏è HeroGen <small>‚Äî Generatore & Trasformatore di immagini</small></h1>

    <!-- INPUT -->
    <div class="card pad">
      <label for="prompt"><strong>Scrivi il tuo prompt:</strong></label>
      <textarea id="prompt" placeholder="Es.: Trasforma in stile cartoon con sfondo citt√† notturna..."></textarea>

      <div class="row">
        <button class="btn" id="genBtn" title="Se carichi una foto far√† la trasformazione, altrimenti genera da testo">Genera / Trasforma</button>
        <button class="btn ghost" id="exBtn">Usa esempio epico</button>
        <button class="btn secondary" id="dlBtn" disabled>Scarica PNG</button>

        <!-- Upload -->
        <input id="fileInput" type="file" accept="image/*" style="display:none" />
        <button class="btn ghost" id="uploadBtn" title="Carica una foto da trasformare">Trasforma da foto</button>
        <span id="fileName" class="muted chip" style="display:none"></span>
      </div>

      <div id="status" class="status" style="display:none"></div>
    </div>

    <!-- IMMAGINE -->
    <div class="viewer">
      <div class="bar">
        <strong>üñºÔ∏è Immagine generata</strong>
        <a id="openFull" href="#" target="_blank" class="muted" style="display:none">Apri grande ‚Üó</a>
      </div>
      <div class="imgBox" id="imgBox">
        <span class="muted">Nessuna immagine ancora</span>
      </div>
      <div class="muted" id="imgHint">‚Äî</div>
    </div>
  </div>

  <script defer>
  (function(){
    "use strict";
    window.addEventListener("DOMContentLoaded", () => {
      const $ = (s)=>document.querySelector(s);

      // UI elements
      const genBtn   = $("#genBtn");
      const exBtn    = $("#exBtn");
      const dlBtn    = $("#dlBtn");
      const imgBox   = $("#imgBox");
      const status   = $("#status");
      const imgHint  = $("#imgHint");
      const promptEl = $("#prompt");
      const openFull = $("#openFull");
      const uploadBtn= $("#uploadBtn");
      const fileInput= $("#fileInput");
      const fileName = $("#fileName");

      if(!genBtn) return;

      // Endpoints
      const BASE = (()=>{
        const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1" || location.protocol === "file:";
        return isLocal ? "http://localhost:3000" : "";
      })();
      const GEN_URL  = `${BASE}/api/generate`;
      const EDIT_URL = `${BASE}/api/edit`;

      // Example
      const epic = `Turn this photo into a clean cartoon illustration: bold outlines, flat vibrant colors, simple background with a night city skyline and neon lights. If no photo is provided, generate the image from scratch with the same style.`;

      exBtn.addEventListener("click", ()=>{ promptEl.value = epic; promptEl.focus(); });

      // Upload
      uploadBtn.addEventListener("click", ()=> fileInput.click());
      let lastFile = null;
      fileInput.addEventListener("change", ()=>{
        const f = fileInput.files?.[0] || null;
        lastFile = f;
        if (f){
          fileName.textContent = `Selezionato: ${f.name}`;
          fileName.style.display = "inline-block";
        } else {
          fileName.textContent = "";
          fileName.style.display = "none";
        }
      });

      // Helpers
      function showStatus(message, isErr=false){
        status.style.display = "block";
        status.className = "status " + (isErr? "err":"ok");
        status.innerHTML = message;
      }
      function lockUI(disabled){
        genBtn.disabled = disabled;
        exBtn.disabled  = disabled;
        uploadBtn.disabled = disabled;
        promptEl.disabled = disabled;
        dlBtn.disabled = disabled || !lastImageUrl;
      }
      function downloadDataUrl(filename, dataUrl){
        const a = document.createElement("a");
        a.href = dataUrl; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
      }

      let lastImageUrl = null;

      // Main action
      genBtn.addEventListener("click", async ()=>{
        const prompt = (promptEl.value || "").trim();
        if (prompt.length < 3) return showStatus("Inserisci un prompt.", true);

        lockUI(true);
        showStatus(`<span class="spin"></span>Elaborazione...`);
        imgHint.textContent = lastFile ? "edit: gpt-image-1" : "generate: gpt-image-1";
        imgBox.innerHTML = `<span class="muted">Attendo immagine...</span>`;
        openFull.style.display = "none"; openFull.removeAttribute("href");
        dlBtn.disabled = true; lastImageUrl = null;

        try {
          let r;
          if (lastFile) {
            // Trasformazione foto ‚Üí /api/edit
            const form = new FormData();
            form.append("prompt", prompt);
            form.append("file", lastFile);
            r = await fetch(EDIT_URL, { method:"POST", body: form });
          } else {
            // Generazione da testo ‚Üí /api/generate
            r = await fetch(GEN_URL, {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ prompt })
            });
          }

          const text = await r.text();
          let data; try{ data = JSON.parse(text); } catch { data = { raw: text }; }

          if(!r.ok){
            const msg = data?.error || `Errore ${r.status}`;
            showStatus(`‚ùå ${msg}`, true);
            imgHint.textContent = "‚Äî";
            imgBox.innerHTML = `<span class="muted">Nessuna immagine</span>`;
            return;
          }

          const url = data.image_url;
          if (url){
            imgBox.innerHTML = "";
            const img = new Image();
            img.alt = "Immagine generata";
            img.src = url;
            img.onload = ()=>{
              imgBox.appendChild(img);
              imgHint.textContent = "ok";
              openFull.href = url; openFull.style.display = "inline";
              lastImageUrl = url; dlBtn.disabled = false;
              showStatus("‚úÖ Fatto!");
            };
            img.onerror = ()=>{
              imgBox.innerHTML = `<span class="muted">Immagine non caricata</span>`;
              imgHint.textContent = "errore immagine";
              showStatus("‚ùå Errore caricamento immagine", true);
            };
          } else {
            imgBox.innerHTML = `<span class="muted">Nessuna immagine ricevuta</span>`;
            imgHint.textContent = "‚Äî";
            showStatus("‚ùå Nessuna immagine ricevuta", true);
          }
        } catch (e){
          console.error(e);
          showStatus("‚ùå Errore di rete o server.", true);
        } finally {
          lockUI(false);
        }
      });

      dlBtn.addEventListener("click", ()=>{ if(lastImageUrl) downloadDataUrl("herogen.png", lastImageUrl); });
    });
  })();
  </script>
</body>
</html>

